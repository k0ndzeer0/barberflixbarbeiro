<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Painel Barbeiro - Barberflix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #fff; overflow-x: hidden; }
        
        /* Layout Principal - Sidebar + Content */
        .main-layout { display: flex; min-height: 100vh; }
        
        /* Sidebar Lateral */
        .sidebar { width: 250px; background: #161b22; border-right: 1px solid rgba(255,255,255,0.1); position: fixed; height: 100vh; left: 0; top: 0; z-index: 1000; overflow-y: auto; }
        .sidebar-logo { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
        .sidebar-logo img { height: 80px; width: auto; }
        .sidebar-logo-text { display: none; }
        .sidebar-nav { padding: 10px 0; }
        .sidebar-nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #8b949e; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; font-size: 14px; }
        .sidebar-nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar-nav-item.active { background: rgba(229, 9, 20, 0.15); color: #e50914; border-left-color: #e50914; }
        .sidebar-nav-item-icon { font-size: 18px; width: 24px; text-align: center; }
        
        /* Header Superior */
        .header { background: #161b22; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; width: 100%; box-sizing: border-box; }
        .header-title { font-size: 18px; font-weight: 600; color: #fff; margin: 0; }
        .mobile-menu-btn { display: none; background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 8px; margin-right: 15px; }
        .header-user { display: flex; align-items: center; gap: 15px; }
        .header-user-info { display: flex; flex-direction: column; align-items: flex-end; }
        .header-user-name { font-size: 14px; color: #fff; font-weight: 500; margin: 0; }
        .header-user-email { font-size: 12px; color: #8b949e; margin: 0; }
        .header-user-avatar { width: 35px; height: 35px; border-radius: 50%; background: #e50914; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; flex-shrink: 0; }
        .header-logout { padding: 6px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #8b949e; cursor: pointer; font-size: 13px; transition: all 0.3s; font-family: inherit; }
        .header-logout:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        .header-logout:active { transform: scale(0.98); }
        
        /* Indicador de Requisi√ß√µes na Fila */
        .queue-indicator {
            display: none;
            padding: 6px 12px;
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.5);
            border-radius: 6px;
            color: #ff9800;
            font-size: 12px;
            margin-right: 10px;
        }
        .queue-indicator.active {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .queue-indicator .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 152, 0, 0.3);
            border-top-color: #ff9800;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #161b22;
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid #e50914;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .toast.success {
            border-left-color: #0f0;
        }
        .toast.error {
            border-left-color: #f00;
        }
        .toast.warning {
            border-left-color: #ff9800;
        }
        .toast.info {
            border-left-color: #2196F3;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .toast-icon {
            font-size: 20px;
        }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #fff;
        }
        .toast-message {
            font-size: 0.9rem;
            color: #8b949e;
        }
        .toast-close {
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toast-close:hover {
            color: #fff;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(229, 9, 20, 0.3);
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Content Area */
        .content-area { margin-left: 250px; flex: 1; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        /* Nav Tabs (removido - agora √© sidebar) */
        .nav-tabs { display: none; }
        .nav-tab { display: none; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-container { background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #ccc; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #e50914; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 10px 20px; background: #e50914; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .btn:hover { background: #f40612; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(229, 9, 20, 0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3); }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: rgba(0,255,0,0.1); border: 1px solid rgba(0,255,0,0.3); color: #0f0; }
        .alert-error { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #f00; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .table th { color: #e50914; font-weight: 600; }
        .table tr:hover { background: rgba(255,255,255,0.05); }
        h2 { margin-bottom: 20px; font-size: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; transition: all 0.3s; }
        .stat-card:hover { border-color: rgba(229, 9, 20, 0.3); transform: translateY(-2px); }
        .stat-value { font-size: 2rem; font-weight: bold; color: #e50914; margin-bottom: 5px; }
        .stat-label { color: #8b949e; font-size: 0.9rem; }
        /* Menu Mobile Hamb√∫rguer */
        .mobile-menu-btn { display: none; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 999; }
        
        @media (max-width: 1024px) {
            .header-user-info { display: none; }
            .header-user-email { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-row { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) { 
            .mobile-menu-btn { display: block; }
            .sidebar { 
                transform: translateX(-100%); 
                transition: transform 0.3s ease;
                width: 280px;
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .sidebar-logo-text { display: none; }
            .header { margin-left: 0; padding: 12px 20px; }
            .content-area { margin-left: 0; }
            .form-row { grid-template-columns: 1fr; } 
            .container { padding: 20px 15px; }
            .form-container { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .table { font-size: 0.85rem; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .table thead, .table tbody, .table tr { display: block; }
            .table th, .table td { 
                padding: 10px 8px; 
                display: block;
                text-align: left;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            .table th { border-bottom: 2px solid rgba(255,255,255,0.2); }
            h2 { font-size: 1.5rem; }
            #loginContainer > div { padding: 30px 20px; width: 95%; max-width: 100%; }
            .header-user { gap: 10px; }
            .header-user-name { font-size: 12px; }
            .header-logout { padding: 6px 12px; font-size: 12px; }
            .toast-container { right: 10px; left: 10px; max-width: calc(100% - 20px); }
            .toast { min-width: auto; max-width: 100%; }
        }
        
        @media (max-width: 480px) {
            .sidebar { width: 100%; max-width: 300px; }
            .header { padding: 10px 15px; }
            .header-title { font-size: 16px; }
            .content-area { margin-left: 0; }
            .container { padding: 15px 10px; }
            .form-container { padding: 15px; }
            .form-group input, .form-group textarea { 
                font-size: 16px; 
                padding: 14px; 
                -webkit-appearance: none;
                appearance: none;
                border-radius: 5px;
            }
            .btn { 
                padding: 12px 20px; 
                font-size: 14px; 
                width: 100%;
                touch-action: manipulation;
            }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 8px 6px; }
            #loginContainer > div { padding: 25px 15px; }
            .sidebar-nav-item { padding: 14px 20px; font-size: 15px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.5rem; }
            .header-user-avatar { width: 30px; height: 30px; font-size: 12px; }
            .queue-indicator { font-size: 11px; padding: 4px 8px; }
        }
        
        @media (max-width: 360px) {
            .container { padding: 10px 8px; }
            .form-container { padding: 12px; }
            .header { padding: 8px 12px; }
            .header-title { font-size: 14px; }
            .sidebar-nav-item { padding: 12px 15px; font-size: 14px; }
        }
        
        /* Otimiza√ß√µes de Performance */
        * { 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        .sidebar, .content-area {
            will-change: transform;
        }
        
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Melhorias de Touch */
        button, .btn, .sidebar-nav-item {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, select {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar Lateral -->
        <div class="sidebar">
            <div class="sidebar-logo" onclick="window.location.href='barberflix-cliente.html'" style="cursor: pointer;">
                <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                     alt="Barberflix Logo">
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-item active" onclick="showTab('dashboard'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üìä</span>
                    <span class="sidebar-nav-item-text">Dashboard</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('appointments'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üìÖ</span>
                    <span class="sidebar-nav-item-text">Agendamentos</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('clients'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üë•</span>
                    <span class="sidebar-nav-item-text">Clientes</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('services'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">‚úÇÔ∏è</span>
                    <span class="sidebar-nav-item-text">Produtos</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('financial'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üí∞</span>
                    <span class="sidebar-nav-item-text">Financeiro</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('employees'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üë®‚Äçüíº</span>
                    <span class="sidebar-nav-item-text">Funcion√°rios</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('expenses'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üí∏</span>
                    <span class="sidebar-nav-item-text">Despesas</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('register'); closeMobileMenuOnClick();">
                    <span class="sidebar-nav-item-icon">üè™</span>
                    <span class="sidebar-nav-item-text">Minha Barbearia</span>
                </div>
            </nav>
        </div>

        <!-- Overlay para fechar sidebar no mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Header Superior -->
    <header class="header">
                <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()" aria-label="Menu">‚ò∞</button>
                <div class="header-title" id="pageTitle">Dashboard</div>
                <div class="header-user">
                    <div class="queue-indicator" id="queueIndicator">
                        <div class="spinner"></div>
                        <span id="queueCount">0</span> requisi√ß√µes na fila
                    </div>
                    <div class="header-user-info">
                        <div class="header-user-name" id="userName">Carregando...</div>
                        <div class="header-user-email" id="userEmail"></div>
                    </div>
                    <div class="header-user-avatar" id="userAvatar">C</div>
                    <button class="header-logout" type="button" onclick="logout()">Sair</button>
                </div>
    </header>
    
            <!-- Container Principal -->
    <div class="container">
        <div id="dashboard" class="tab-content active">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Dashboard</h2>
                <p style="color: #999; font-size: 0.9rem;">Vis√£o geral do seu neg√≥cio</p>
            </div>
            
            <!-- Cards de M√©tricas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statToday">0</div>
                    <div class="stat-label">Agendamentos Hoje</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">üìÖ</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statPending">0</div>
                            <div class="stat-label">Agendamentos Pendentes</div>
                </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">‚è≥</div>
            </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statRevenue">R$ 0,00</div>
                            <div class="stat-label">Faturamento do M√™s</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">üí∞</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statConfirmed">0</div>
                            <div class="stat-label">Agendamentos Confirmados</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">‚úÖ</div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√µes de Informa√ß√£o -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <!-- Pr√≥ximos Agendamentos -->
                <div class="form-container">
                    <h3 style="margin-bottom: 15px; color: #e50914;">Pr√≥ximos Agendamentos (3 horas)</h3>
                    <div id="upcomingAppointments" style="min-height: 200px;">
                        <p style="color: #999; text-align: center; padding: 20px;">Carregando...</p>
                    </div>
                </div>

                <!-- Agendamentos que Precisam de Aten√ß√£o -->
                <div class="form-container">
                    <h3 style="margin-bottom: 15px; color: #e50914;">‚ö†Ô∏è Agendamentos Pendentes</h3>
                    <div id="pendingAppointments" style="min-height: 200px;">
                        <p style="color: #999; text-align: center; padding: 20px;">Carregando...</p>
                    </div>
                </div>
            </div>

            <div id="barberShopInfo" class="form-container" style="margin-top: 20px; display: none;"></div>
        </div>

        <!-- NOVA ABA: AGENDAMENTOS -->
        <div id="appointments" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Agendamentos</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie todos os agendamentos da sua barbearia</p>
            </div>

            <!-- Filtros -->
            <div class="form-container" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filterStatus" onchange="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="all">Todos</option>
                            <option value="pending">Pendentes</option>
                            <option value="confirmed">Confirmados</option>
                            <option value="rejected">Recusados</option>
                            <option value="completed">Conclu√≠dos</option>
                            <option value="cancelled">Cancelados</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Data</label>
                        <select id="filterDate" onchange="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month">Este M√™s</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Profissional</label>
                        <select id="filterProfessional" onchange="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="all">Todos os Profissionais</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Buscar Cliente</label>
                        <input type="text" id="searchClient" placeholder="Nome ou email..." onkeyup="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                    </div>
                </div>
            </div>

            <!-- Lista de Agendamentos -->
            <div id="appointmentsList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Carregando agendamentos...</p>
            </div>
        </div>

        <!-- NOVA ABA: CLIENTES -->
        <div id="clients" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Clientes</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie seus clientes</p>
            </div>
            <div id="clientsList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <div id="services" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Produtos/Servi√ßos</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie os servi√ßos oferecidos pela sua barbearia</p>
            </div>
            <div class="form-container">
                <div id="serviceAlert" class="alert"></div>
                <form id="serviceForm" onsubmit="handleAddService(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" id="serviceName" required>
                        </div>
                        <div class="form-group">
                            <label>Pre√ßo *</label>
                            <input type="number" id="servicePrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Dura√ß√£o (minutos) *</label>
                        <input type="number" id="serviceDuration" required>
                    </div>
                    <button type="submit" class="btn">Adicionar</button>
                </form>
            </div>
            <div id="servicesList" class="form-container"></div>
        </div>

        <!-- NOVA ABA: FINANCEIRO -->
        <div id="financial" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Financeiro</h2>
                <p style="color: #999; font-size: 0.9rem;">Acompanhe receitas e despesas</p>
            </div>
            <div id="financialContent" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <!-- NOVA ABA: FUNCION√ÅRIOS -->
        <div id="employees" class="tab-content">
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="color: #e50914; margin-bottom: 5px;">Funcion√°rios / Profissionais</h2>
                        <p style="color: #999; font-size: 0.9rem;">Gerencie sua equipe de profissionais</p>
                    </div>
                    <button class="btn" onclick="exportEmployeesPDF()" style="margin-left: 20px;">
                        üìÑ Exportar PDF
                    </button>
                </div>
            </div>
            <div id="employeesList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Carregando...</p>
            </div>
        </div>

        <!-- NOVA ABA: DESPESAS -->
        <div id="expenses" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Despesas</h2>
                <p style="color: #999; font-size: 0.9rem;">Controle seus gastos</p>
            </div>
            <div id="expensesList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <div id="register" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Minha Barbearia</h2>
                <p style="color: #999; font-size: 0.9rem;">Configure as informa√ß√µes da sua barbearia</p>
            </div>
            <div class="form-container">
                <div id="registerAlert" class="alert"></div>
                <form id="registerShopForm" onsubmit="handleRegisterShop(event)">
                    <div class="form-group">
                        <label>Nome da Barbearia *</label>
                        <input type="text" id="shopName" required>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="shopDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo *</label>
                        <input type="text" id="shopAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Bairro *</label>
                        <input type="text" id="shopNeighborhood" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cidade *</label>
                            <input type="text" id="shopCity" required>
                        </div>
                        <div class="form-group">
                            <label>Estado *</label>
                            <input type="text" id="shopState" required maxlength="2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CEP *</label>
                        <input type="text" id="shopZip" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="shopPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="shopEmail">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="tel" id="shopWhatsapp" placeholder="Ex: 5514999999999 (com DDD e c√≥digo do pa√≠s)">
                        <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Formato: c√≥digo do pa√≠s + DDD + n√∫mero (ex: 5514999999999)</small>
                    </div>
                    <div class="form-group">
                        <label>Foto de Capa</label>
                        <input type="file" id="coverImage" accept="image/*" onchange="previewImage(this, 'coverPreview')">
                        <img id="coverPreview" style="display: none; max-width: 100%; margin-top: 10px; border-radius: 5px; max-height: 200px;">
                    </div>
                    <div class="form-group">
                        <label>Foto de Perfil</label>
                        <input type="file" id="profileImage" accept="image/*" onchange="previewImage(this, 'profilePreview')">
                        <img id="profilePreview" style="display: none; max-width: 100%; margin-top: 10px; border-radius: 50%; max-height: 150px; width: 150px; object-fit: cover;">
                    </div>
                    
                    <hr style="border: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">
                    <h3 style="margin-bottom: 20px; color: #e50914;">‚è∞ Hor√°rios de Funcionamento</h3>
                    <p style="color: #999; font-size: 0.9rem; margin-bottom: 20px;">Configure os hor√°rios em que sua barbearia est√° aberta. Os clientes s√≥ poder√£o agendar nestes hor√°rios.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hor√°rio de Abertura *</label>
                            <input type="time" id="shopOpenTime" required value="08:00">
                            <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Ex: 08:00</small>
                        </div>
                        <div class="form-group">
                            <label>Hor√°rio de Fechamento *</label>
                            <input type="time" id="shopCloseTime" required value="19:00">
                            <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Ex: 19:00</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Intervalo entre Agendamentos *</label>
                        <select id="shopInterval" required style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="15">15 minutos</option>
                            <option value="30" selected>30 minutos</option>
                            <option value="45">45 minutos</option>
                            <option value="60">1 hora</option>
                        </select>
                        <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Tempo m√≠nimo entre cada agendamento</small>
                    </div>
                    
                    <button type="submit" class="btn">Salvar</button>
                </form>
            </div>
        </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const SUPABASE_URL = 'https://tvvqwlxmpmolnyavabqq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dnF3bHhtcG1vbG55YXZhYnFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5MjMsImV4cCI6MjA3ODY2NDkyM30.5FW2R9rcYXpAvpAjWnviBRIjeQOVf2pZwWrYrqljdHw';
        
        // ========================================
        // CONFIGURA√á√ÉO SUPABASE - FUNCIONA EM QUALQUER PC
        // ========================================
        // A sess√£o √© salva no localStorage do navegador, ent√£o funciona em qualquer PC
        // quando o usu√°rio fizer login. Cada PC ter√° sua pr√≥pria sess√£o local.
        // Se quiser sincronizar entre PCs, seria necess√°rio usar cookies compartilhados
        // ou um sistema de sincroniza√ß√£o mais complexo.
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,        // Salva sess√£o automaticamente
                autoRefreshToken: true,      // Renova token automaticamente
                detectSessionInUrl: true     // Detecta sess√£o na URL (reset de senha)
            }
        });
        
        let currentUser = null;
        
        // ========================================
        // FUN√á√ÉO PARA MENU MOBILE
        // ========================================
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
                
                // Prevenir scroll do body quando menu estiver aberto
                if (sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        }
        
        // Fechar menu ao clicar em um item (mobile)
        function closeMobileMenuOnClick() {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar) sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ========================================
        // SISTEMA DE CACHE E OTIMIZA√á√ïES
        // ========================================
        let dataCache = {
            appointments: null,
            shop: null,
            lastFetch: null,
            cacheDuration: 30000 // 30 segundos de cache
        };
        
        let isLoading = false;
        let reloadDebounceTimer = null;
        
        // ========================================
        // SISTEMA DE TOAST NOTIFICATIONS
        // ========================================
        function showToast(title, message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remover ap√≥s dura√ß√£o
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ========================================
        // ATUALIZAR INDICADOR DE FILA
        // ========================================
        function updateQueueIndicator() {
            const indicator = document.getElementById('queueIndicator');
            const countEl = document.getElementById('queueCount');
            
            if (!indicator || !countEl) return;
            
            const count = requestQueue.length;
            
            if (count > 0) {
                indicator.classList.add('active');
                countEl.textContent = count;
            } else {
                indicator.classList.remove('active');
            }
        }
        
        // ========================================
        // FUN√á√ÉO DE RECARREGAMENTO COM DEBOUNCE
        // ========================================
        function debouncedReload(fn, delay = 1000) {
            if (reloadDebounceTimer) {
                clearTimeout(reloadDebounceTimer);
            }
            
            reloadDebounceTimer = setTimeout(() => {
                fn();
                reloadDebounceTimer = null;
            }, delay);
        }
        
        // ========================================
        // VERIFICAR CACHE ANTES DE BUSCAR DADOS
        // ========================================
        function isCacheValid() {
            if (!dataCache.lastFetch) return false;
            const now = Date.now();
            return (now - dataCache.lastFetch) < dataCache.cacheDuration;
        }
        
        async function checkAuth() {
            // Verificar se h√° sess√£o v√°lida
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.warn('Erro ao verificar sess√£o:', error);
                    showLoginScreen();
                    return;
                }
                
                // Se h√° sess√£o, verificar se √© v√°lida e restaurar
                if (session && session.user) {
                    console.log('‚úÖ Sess√£o encontrada, verificando permiss√µes...');
                    
                    // Verificar se √© barbeiro
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('user_type, email, full_name')
                        .eq('id', session.user.id)
                        .maybeSingle();
                    
                    if (profile && profile.user_type === 'barber') {
                        // Verificar se tem barbearia
                        const { data: shop } = await supabase
                            .from('barbershops')
                            .select('id, name')
                            .eq('barber_id', session.user.id)
                            .maybeSingle();
                        
                        if (shop && shop.id) {
                            // Restaurar sess√£o
                            currentUser = session.user;
                            window.currentUser = session.user;
                            
                            // Atualizar info do usu√°rio no header
                            if (profile.full_name) {
                                document.getElementById('userName').textContent = profile.full_name;
                                document.getElementById('userAvatar').textContent = profile.full_name.charAt(0).toUpperCase();
                            } else if (session.user.email) {
                                const emailParts = session.user.email.split('@');
                                document.getElementById('userName').textContent = emailParts[0] || 'Usu√°rio';
                                document.getElementById('userEmail').textContent = session.user.email;
                                document.getElementById('userAvatar').textContent = emailParts[0].charAt(0).toUpperCase() || 'U';
                            }
                            
                            // Mostrar dashboard
                            hideLoginScreen();
                            
                            // Inicializar Realtime subscriptions
                            initializeRealtimeSubscriptions(shop.id);
                            
                            // Iniciar polling para atualiza√ß√£o autom√°tica
                            startPolling();
                            
                            // Carregar dashboard
                            setTimeout(() => {
                                loadBarberDashboard();
                            }, 500);
                            
                            console.log('‚úÖ Sess√£o restaurada com sucesso');
                            return;
                        }
                    }
                }
                
                // Se n√£o h√° sess√£o v√°lida, mostrar login
                showLoginScreen();
                
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                showLoginScreen();
            }
        }
        
        function showLoginScreen() {
            // Esconder todo o conte√∫do do painel
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.style.display = 'none';
            
            // Criar tela de login
            const loginContainer = document.createElement('div');
            loginContainer.id = 'loginContainer';
            loginContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            loginContainer.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 40px; max-width: 450px; width: 90%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                             alt="Barberflix Logo" 
                             style="height: 80px; margin-bottom: 15px;">
                        <h1 style="color: #e50914; font-size: 2rem; margin-bottom: 10px;">Barberflix</h1>
                        <p style="color: #999;">Painel do Barbeiro</p>
                    </div>
                    <div id="loginAlert" class="alert"></div>
                    <form id="loginForm" onsubmit="handleBarberLogin(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="text" id="barberEmail" required placeholder="seu@email.com ou username">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="barberPassword" required placeholder="Sua senha">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="rememberBarber" style="width: auto;">
                                <label for="rememberBarber" style="margin: 0; color: #999; font-size: 0.9rem;">Manter logado</label>
                            </div>
                            <a href="#" onclick="event.preventDefault(); showForgotPasswordModal();" style="color: #e50914; text-decoration: none; font-size: 0.9rem;">Esqueci minha senha</a>
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Entrar</button>
                    </form>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="javascript:void(0);" onclick="window.location.reload();" style="color: #999; text-decoration: none; font-size: 0.9rem;">Recarregar p√°gina</a>
                    </div>
                </div>
            `;
            document.body.appendChild(loginContainer);
        }
        
        function hideLoginScreen() {
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.remove();
            }
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.style.display = 'flex';
        }
        
        // Fun√ß√£o para mostrar modal de "Esqueci minha senha"
        function showForgotPasswordModal() {
            const modal = document.createElement('div');
            modal.id = 'forgotPasswordModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 40px; max-width: 450px; width: 90%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #e50914; font-size: 1.5rem; margin-bottom: 10px;">Esqueci minha senha</h2>
                        <p style="color: #999; font-size: 0.9rem;">Digite seu email ou username para receber o link de redefini√ß√£o</p>
                    </div>
                    <div id="forgotPasswordAlert" class="alert"></div>
                    <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
                        <div class="form-group">
                            <label>Email ou Username</label>
                            <input type="text" id="forgotPasswordEmail" required placeholder="seu@email.com ou username" autocomplete="username">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn" style="flex: 1;">Enviar Link de Redefini√ß√£o</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('forgotPasswordModal').remove();" style="flex: 1;">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Fun√ß√£o para processar reset de senha
        async function handleForgotPassword(e) {
            e.preventDefault();
            const alert = document.getElementById('forgotPasswordAlert');
            const btn = e.target.querySelector('button[type="submit"]');
            const emailOrUsername = document.getElementById('forgotPasswordEmail').value.trim();
            
            try {
                btn.disabled = true;
                btn.textContent = 'Enviando...';
                
                if (!emailOrUsername) {
                    throw new Error('Digite seu email ou username');
                }
                
                // Se for username, buscar email
                let email = emailOrUsername;
                if (!emailOrUsername.includes('@')) {
                    showAlert(alert, 'Buscando email...', 'success');
                    
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('email')
                        .eq('username', emailOrUsername.toLowerCase().trim())
                        .maybeSingle();
                    
                    if (profileError || !profile || !profile.email) {
                        throw new Error('Username n√£o encontrado. Verifique e tente novamente.');
                    }
                    
                    email = profile.email;
                }
                
                // Enviar email de reset de senha
                showAlert(alert, 'Enviando email de redefini√ß√£o...', 'success');
                
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/barberflix-barbeiro.html?reset=true`
                });
                
                if (error) {
                    throw new Error('Erro ao enviar email: ' + error.message);
                }
                
                showAlert(alert, '‚úÖ Email de redefini√ß√£o enviado! Verifique sua caixa de entrada e siga as instru√ß√µes.', 'success');
                btn.textContent = '‚úÖ Enviado!';
                btn.disabled = true;
                
                // Fechar modal ap√≥s 3 segundos
                setTimeout(() => {
                    const modal = document.getElementById('forgotPasswordModal');
                    if (modal) modal.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Erro ao resetar senha:', error);
                showAlert(alert, '‚ùå ' + (error.message || 'Erro ao enviar email de redefini√ß√£o'), 'error');
                btn.disabled = false;
                btn.textContent = 'Enviar Link de Redefini√ß√£o';
            }
        }
        
        // ADICIONAR ESTA FUN√á√ÉO NOVA - ANTES DE handleBarberLogin
        async function loginWithUsernameOrEmail(usernameOrEmail, password) {
            // Se n√£o tem @, √© username - buscar email correspondente
            if (!usernameOrEmail.includes('@')) {
                console.log('üîç Buscando email para username:', usernameOrEmail);
                
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('email')
                    .eq('username', usernameOrEmail.toLowerCase().trim())
                    .maybeSingle();
                
                if (profileError || !profile) {
                    throw new Error('Username n√£o encontrado');
                }
                
                usernameOrEmail = profile.email;
                console.log('‚úÖ Email encontrado:', usernameOrEmail);
            }
            
            // Fazer login com email
            const { data, error } = await supabase.auth.signInWithPassword({
                email: usernameOrEmail,
                password: password
            });
            
            if (error) throw error;
            return data;
        }
        
        async function handleBarberLogin(e) {
            e.preventDefault();
            const alert = document.getElementById('loginAlert');
            const btn = e.target.querySelector('button[type="submit"]');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Entrando...';
                
                const email = document.getElementById('barberEmail').value.trim();
                const password = document.getElementById('barberPassword').value;
                
                if (!email || !password) {
                    throw new Error('Preencha email e senha');
                }
                
                // Limpar alerta anterior
                showAlert(alert, 'Verificando credenciais...', 'success');
                
                // ‚úÖ USAR A NOVA FUN√á√ÉO QUE ACEITA USERNAME OU EMAIL
                let data;
                try {
                    data = await loginWithUsernameOrEmail(email, password);
                } catch (loginError) {
                    console.error('Erro de autentica√ß√£o:', loginError);
                    if (loginError.message.includes('Invalid login credentials') || loginError.message.includes('invalid') || loginError.message.includes('Username n√£o encontrado')) {
                        throw new Error('Email/username ou senha incorretos. Verifique suas credenciais.');
                    }
                    throw loginError;
                }
                
                if (!data || !data.user) {
                    throw new Error('Erro ao fazer login. Tente novamente.');
                }
                
                // VERIFICAR SE √â BARBEIRO ANTES DE PERMITIR LOGIN
                showAlert(alert, 'Verificando permiss√µes...', 'success');
                
                // Buscar perfil do usu√°rio
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('user_type, email, full_name')
                    .eq('id', data.user.id)
                    .maybeSingle();
                
                if (profileError) {
                    throw new Error('Erro ao verificar perfil: ' + profileError.message);
                }
                
                if (!profile) {
                    await supabase.auth.signOut();
                    throw new Error('Perfil n√£o encontrado. Voc√™ precisa ser cadastrado como barbeiro pelo administrador.');
                }
                
                // VERIFICAR SE √â BARBEIRO
                if (profile.user_type !== 'barber') {
                    await supabase.auth.signOut();
                    throw new Error('Acesso negado. Apenas barbeiros podem acessar este painel. Seu tipo de usu√°rio: ' + (profile.user_type || 'n√£o definido'));
                }
                
                // VERIFICAR SE TEM BARBEARIA CADASTRADA
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', data.user.id)
                    .maybeSingle();
                
                if (shopError && !shopError.message.includes('No rows')) {
                    throw new Error('Erro ao verificar barbearia: ' + shopError.message);
                }
                
                if (!shop || !shop.id) {
                    await supabase.auth.signOut();
                    throw new Error('Voc√™ n√£o possui uma barbearia cadastrada. Entre em contato com o administrador para cadastrar sua barbearia.');
                }
                
                // SE CHEGOU AQUI, √â BARBEIRO E TEM BARBEARIA
                currentUser = data.user;
                window.currentUser = data.user;
                
                console.log('‚úÖ Login autorizado - Barbeiro:', profile.full_name || profile.email);
                console.log('‚úÖ Barbearia:', shop.name);
                
                showAlert(alert, 'Login realizado com sucesso!', 'success');
                
                // Atualizar info do usu√°rio no header
                if (profile.full_name) {
                    document.getElementById('userName').textContent = profile.full_name;
                    document.getElementById('userAvatar').textContent = profile.full_name.charAt(0).toUpperCase();
                } else if (data.user && data.user.email) {
                    const emailParts = data.user.email.split('@');
                    document.getElementById('userName').textContent = emailParts[0] || 'Usu√°rio';
                    document.getElementById('userEmail').textContent = data.user.email;
                    document.getElementById('userAvatar').textContent = emailParts[0].charAt(0).toUpperCase() || 'U';
                }
                
                // Mostrar dashboard
                hideLoginScreen();
                
                // Inicializar Realtime subscriptions
                initializeRealtimeSubscriptions(shop.id);
                
                // Iniciar polling para atualiza√ß√£o autom√°tica
                startPolling();
                
                setTimeout(() => {
                    loadBarberDashboard();
                }, 500);
                
            } catch (error) {
                console.error('Erro no login:', error);
                showAlert(alert, error.message || 'Erro ao fazer login. Verifique suas credenciais.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }
        
        // ========================================
        // SISTEMA DE REALTIME SUBSCRIPTIONS
        // ========================================
        let realtimeSubscriptions = [];
        
        async function initializeRealtimeSubscriptions(shopId) {
            // Limpar subscriptions anteriores
            cleanupRealtimeSubscriptions();
            
            if (!shopId || !currentUser) {
                console.warn('‚ö†Ô∏è N√£o √© poss√≠vel inicializar Realtime: shopId ou currentUser ausente');
                return;
            }
            
            console.log('üîÑ Inicializando Realtime subscriptions para barbearia:', shopId);
            
            try {
                // Subscription para mudan√ßas na barbearia
                const shopChannel = supabase
                    .channel('barbershop-changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'barbershops',
                        filter: `id=eq.${shopId}`
                    }, (payload) => {
                        console.log('üì¢ Mudan√ßa na barbearia detectada:', payload);
                        showToast('Atualiza√ß√£o', 'Dados da barbearia foram atualizados', 'info');
                        
                        // Recarregar formul√°rio se estiver na aba de registro
                        const registerTab = document.getElementById('register');
                        if (registerTab && registerTab.classList.contains('active')) {
                            loadBarberShopForm();
                        }
                        
                        // Atualizar cache
                        dataCache.shop = null;
                        dataCache.lastFetch = null;
                    })
                    .subscribe();
                
                realtimeSubscriptions.push(shopChannel);
                
                // Subscription para agendamentos
                const appointmentsChannel = supabase
                    .channel('appointments-changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'appointments',
                        filter: `barbershop_id=eq.${shopId}`
                    }, (payload) => {
                        console.log('üì¢ Mudan√ßa em agendamentos detectada:', payload);
                        
                        // Recarregar dados se estiver nas abas relevantes
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab) {
                            const tabId = activeTab.id;
                            if (tabId === 'dashboard') {
                                loadBarberDashboard();
                            } else if (tabId === 'appointments') {
                                loadAppointments();
                            } else if (tabId === 'financial') {
                                loadFinancial();
                            } else if (tabId === 'clients') {
                                loadClients();
                            }
                        }
                        
                        // Atualizar cache
                        dataCache.appointments = null;
                        dataCache.lastFetch = null;
                        
                        showToast('Novo Agendamento', 'H√° mudan√ßas nos agendamentos', 'info');
                    })
                    .subscribe();
                
                realtimeSubscriptions.push(appointmentsChannel);
                
                // Subscription para servi√ßos
                const servicesChannel = supabase
                    .channel('services-changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'services',
                        filter: `barbershop_id=eq.${shopId}`
                    }, (payload) => {
                        console.log('üì¢ Mudan√ßa em servi√ßos detectada:', payload);
                        
                        // Recarregar servi√ßos se estiver na aba de servi√ßos
                        const servicesTab = document.getElementById('services');
                        if (servicesTab && servicesTab.classList.contains('active')) {
                            loadServices();
                        }
                        
                        showToast('Servi√ßos', 'Lista de servi√ßos foi atualizada', 'info');
                    })
                    .subscribe();
                
                realtimeSubscriptions.push(servicesChannel);
                
                console.log('‚úÖ Realtime subscriptions inicializadas com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Realtime subscriptions:', error);
            }
        }
        
        function cleanupRealtimeSubscriptions() {
            console.log('üßπ Limpando Realtime subscriptions...');
            realtimeSubscriptions.forEach(channel => {
                supabase.removeChannel(channel);
            });
            realtimeSubscriptions = [];
        }
        
        async function showTab(tabName) {
            // Atualizar t√≠tulo da p√°gina
            const titles = {
                dashboard: 'Dashboard',
                appointments: 'Agendamentos',
                clients: 'Clientes',
                services: 'Produtos',
                financial: 'Financeiro',
                employees: 'Funcion√°rios',
                expenses: 'Despesas',
                register: 'Minha Barbearia'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';
            
            // Atualizar tabs e sidebar
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Ativar item da sidebar correspondente
            const sidebarItems = document.querySelectorAll('.sidebar-nav-item');
            sidebarItems.forEach((item, index) => {
                const tabs = ['dashboard', 'appointments', 'clients', 'services', 'financial', 'employees', 'expenses', 'register'];
                if (tabs[index] === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Garantir que currentUser est√° atualizado antes de carregar
            if (!currentUser || !currentUser.id) {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user && user.id) {
                        currentUser = user;
                        console.log('‚úÖ currentUser atualizado no showTab:', currentUser.id);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar currentUser:', error);
                }
            }
            
            if (tabName === 'dashboard') loadBarberDashboard();
            if (tabName === 'appointments') loadAppointments();
            if (tabName === 'clients') loadClients();
            if (tabName === 'services') loadServices();
            if (tabName === 'financial') loadFinancial();
            if (tabName === 'employees') loadEmployees();
            if (tabName === 'expenses') loadExpenses();
            if (tabName === 'register') loadBarberShopForm();
        }
        
        async function loadBarberDashboard() {
            // Evitar m√∫ltiplos carregamentos simult√¢neos
            if (isLoading) {
                console.log('‚è≥ J√° est√° carregando, aguardando...');
                return;
            }
            
            isLoading = true;
            
            // Mostrar loading com spinner
            document.querySelectorAll('.metric-card').forEach(card => {
                const content = card.querySelector('.metric-value') || card.querySelector('div');
                if (content) {
                    content.innerHTML = '<span class="loading-spinner"></span> Carregando...';
                }
            });
            
            // Verificar cache primeiro
            if (isCacheValid() && dataCache.appointments && dataCache.shop) {
                console.log('üì¶ Usando dados do cache');
                const { appointments, shop } = dataCache;
                updateDashboardUI(appointments, shop);
                isLoading = false;
                return;
            }
            
            try {
                // ========================================
                // BARBEREIRAS = SUPABASE (tabela barbershops)
                // ========================================
                // PRIMEIRO: Buscar informa√ß√µes da barbearia do SUPABASE
                if (!currentUser || !currentUser.id) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                console.log('üìä Buscando barbearia do Supabase (tabela barbershops) para usu√°rio:', currentUser.id);
                
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('*')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shopError) {
                    console.error('‚ùå Erro ao buscar barbearia do Supabase:', shopError);
                    throw new Error('Erro ao buscar informa√ß√µes da barbearia. Verifique sua conex√£o.');
                }
                
                if (!shop || !shop.id) {
                    document.getElementById('barberShopInfo').innerHTML = '<p style="color: #f00; padding: 20px;">‚ö†Ô∏è Cadastre sua barbearia primeiro! <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Ir para cadastro</a></p>';
                    document.getElementById('barberShopInfo').style.display = 'block';
                    throw new Error('Barbearia n√£o cadastrada');
                }
                
                console.log('‚úÖ Barbearia encontrada no Supabase:', shop.name);

                // ========================================
                // AGENDAMENTOS = PLANILHA GOOGLE SHEETS
                // ========================================
                // SEGUNDO: Buscar agendamentos da PLANILHA GOOGLE SHEETS
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                // Buscar colunas A at√© I (incluindo ID na coluna H e Profissional na coluna I)
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:I1000?key=${API_KEY}`;
                
                let response;
                let data;
                let rows = [];
                
                try {
                    const fetchPromise = fetch(sheetsUrl);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout ao buscar planilha')), 10000)
                    );
                    
                    response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                    data = await response.json();
                    rows = data.values || [];
                    console.log(`‚úÖ ${rows.length} linhas encontradas na planilha`);
                } catch (fetchError) {
                    console.error('‚ùå Erro ao buscar planilha:', fetchError);
                    rows = []; // Continuar mesmo sem dados da planilha
                }
                
                // Converter para objetos
                let allAppointments = rows.map((row, index) => {
                    // Formato: Data | Hora | Cliente | Barbearia | Servi√ßos | Observa√ß√µes | Status | ID | Profissional (I)
                    // Verificar se status est√° em G ou se Observa√ß√µes cont√©m status
                    let status = row[6] || 'Pendente';
                    let appointmentId = (row[7] && String(row[7]).trim() !== '') ? String(row[7]).trim() : null; // Coluna H (ID √∫nico)
                    let professional = (row[8] && String(row[8]).trim() !== '') ? String(row[8]).trim() : null; // Coluna I (Profissional)
                    
                    // Log para debug
                    if (!appointmentId && index < 5) { // Log apenas primeiros 5 para n√£o poluir
                        console.log(`‚ö†Ô∏è Linha ${index + 2} sem ID - ser√° usado fallback (data+hora+email)`);
                    }
                    
                    if (!row[6] && row[5]) {
                        // Se n√£o tem status em G, verificar Observa√ß√µes
                        const notes = row[5].toLowerCase();
                        if (notes.includes('pendente')) status = 'Pendente';
                        else if (notes.includes('confirmado')) status = 'Confirmado';
                        else if (notes.includes('recusado') || notes.includes('rejeitado')) status = 'Recusado';
                        else if (notes.includes('conclu√≠do') || notes.includes('concluido')) status = 'Conclu√≠do';
                        else if (notes.includes('cancelado')) status = 'Cancelado';
                    }
                    
                    return {
                        id: `sheet_${index + 2}`, // +2 porque linha real na planilha come√ßa em 2
                        appointment_id: appointmentId, // ID √∫nico da coluna H
                        appointment_date: row[0] || '',
                        appointment_time: row[1] || '',
                        client_email: row[2] || '',
                        barbershop_name: row[3] || '',
                        services: row[4] || '',
                        notes: row[5] || '',
                        professional: professional, // Coluna I - Profissional
                        status: status.toLowerCase()
                            .replace('pendente', 'pending')
                            .replace('confirmado', 'confirmed')
                            .replace('recusado', 'rejected')
                            .replace('rejeitado', 'rejected')
                            .replace('conclu√≠do', 'completed')
                            .replace('concluido', 'completed')
                            .replace('cancelado', 'cancelled')
                            .trim() || 'pending'
                    };
                }).filter(apt => apt.appointment_date && apt.appointment_time);
                
                console.log(`üìã ${allAppointments.length} agendamentos encontrados:`, allAppointments);
                
                // Filtrar agendamentos da planilha usando nome da barbearia do Supabase
                // (Usa informa√ß√µes do Supabase para filtrar dados da planilha)
                if (!shop || !shop.name) {
                    throw new Error('Informa√ß√µes da barbearia incompletas');
                }
                
                console.log('üîç Filtrando agendamentos da planilha usando nome da barbearia do Supabase:', shop.name);
                allAppointments = allAppointments.filter(apt => {
                    if (!apt.barbershop_name) return false;
                    const aptName = apt.barbershop_name.toLowerCase().trim();
                    const shopName = shop.name.toLowerCase().trim();
                    const matchesShop = aptName === shopName || 
                           aptName.includes(shopName) || 
                           shopName.includes(aptName);
                    
                    // N√£o mostrar agendamentos que foram processados recentemente
                    const wasProcessed = isAppointmentProcessed(apt.id);
                    
                    return matchesShop && !wasProcessed;
                });
                
                console.log(`‚úÖ ${allAppointments.length} agendamentos da planilha encontrados para barbearia "${shop.name}" do Supabase`);
                
                const today = new Date().toISOString().split('T')[0];
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                
                // Filtrar agendamentos
                const todayAppointments = allAppointments.filter(apt => apt.appointment_date === today);
                const pendingAppointments = allAppointments.filter(apt => apt.status === 'pending');
                const confirmedAppointments = allAppointments.filter(apt => apt.status === 'confirmed');
                const monthAppointments = allAppointments.filter(apt => 
                    apt.appointment_date >= startOfMonth && 
                    (apt.status === 'confirmed' || apt.status === 'completed')
                );
                
                // Calcular receita
                let revenue = 0;
                monthAppointments.forEach(apt => {
                    const services = apt.services || '';
                    const priceMatch = services.match(/R\$\s*(\d+[\.,]\d+)/);
                    if (priceMatch) {
                        revenue += parseFloat(priceMatch[1].replace(',', '.'));
                    }
                });
                
                // Salvar no cache
                dataCache.appointments = allAppointments;
                dataCache.shop = shop;
                dataCache.lastFetch = Date.now();
                
                // Atualizar UI
                updateDashboardUI(allAppointments, shop);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                showToast('Erro', 'Erro ao carregar dados do dashboard', 'error');
                // Mostrar mensagem de erro
                document.querySelectorAll('.metric-card').forEach(card => {
                    const content = card.querySelector('.metric-value') || card.querySelector('div');
                    if (content) content.textContent = 'Erro';
                });
            } finally {
                isLoading = false;
            }
        }
        
        // Fun√ß√£o para atualizar UI do dashboard (reutiliz√°vel)
        function updateDashboardUI(allAppointments, shop) {
                const today = new Date().toISOString().split('T')[0];
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                
                // Filtrar agendamentos
                const todayAppointments = allAppointments.filter(apt => apt.appointment_date === today);
                const pendingAppointments = allAppointments.filter(apt => apt.status === 'pending');
                const confirmedAppointments = allAppointments.filter(apt => apt.status === 'confirmed');
                const monthAppointments = allAppointments.filter(apt => 
                    apt.appointment_date >= startOfMonth && 
                    (apt.status === 'confirmed' || apt.status === 'completed')
                );
                
                // Calcular receita
                let revenue = 0;
                monthAppointments.forEach(apt => {
                    const services = apt.services || '';
                    const priceMatch = services.match(/R\$\s*(\d+[\.,]\d+)/);
                    if (priceMatch) {
                        revenue += parseFloat(priceMatch[1].replace(',', '.'));
                    }
                });
                
                // Atualizar estat√≠sticas
                document.getElementById('statToday').textContent = todayAppointments.length;
                document.getElementById('statPending').textContent = pendingAppointments.length;
                document.getElementById('statRevenue').textContent = `R$ ${revenue.toFixed(2).replace('.', ',')}`;
                document.getElementById('statConfirmed').textContent = confirmedAppointments.length;
                
                // Pr√≥ximos agendamentos (pr√≥ximas 3 horas)
                const now = new Date();
                const threeHoursLater = new Date(now.getTime() + 3 * 60 * 60 * 1000);
                const upcoming = todayAppointments
                    .filter(apt => {
                        const aptTime = apt.appointment_time.split(':');
                        const aptHour = parseInt(aptTime[0]);
                        const aptMin = parseInt(aptTime[1]);
                        const nowHour = now.getHours();
                        const nowMin = now.getMinutes();
                        const laterHour = threeHoursLater.getHours();
                        const laterMin = threeHoursLater.getMinutes();
                        
                        const aptTotal = aptHour * 60 + aptMin;
                        const nowTotal = nowHour * 60 + nowMin;
                        const laterTotal = laterHour * 60 + laterMin;
                        
                        return aptTotal >= nowTotal && aptTotal <= laterTotal && 
                               (apt.status === 'confirmed' || apt.status === 'pending');
                    })
                    .sort((a, b) => a.appointment_time.localeCompare(b.appointment_time))
                    .slice(0, 5);
                
                if (upcoming.length > 0) {
                    document.getElementById('upcomingAppointments').innerHTML = upcoming.map(apt => `
                        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${apt.client_email || 'Cliente'}</div>
                                <div style="color: #999; font-size: 0.9rem;">‚è∞ ${apt.appointment_time}</div>
                            </div>
                            <span style="padding: 5px 10px; background: ${apt.status === 'confirmed' ? 'rgba(0,255,0,0.2)' : 'rgba(255,152,0,0.2)'}; border-radius: 5px; font-size: 0.85rem;">
                                ${apt.status === 'confirmed' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('upcomingAppointments').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum agendamento nas pr√≥ximas 3 horas</p>';
                }
                
                // Agendamentos pendentes (top 5)
                if (pendingAppointments.length > 0) {
                    const topPending = pendingAppointments.slice(0, 5);
                    document.getElementById('pendingAppointments').innerHTML = topPending.map(apt => `
                        <div data-appointment-id="${apt.id}" style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); transition: opacity 0.3s;">
                            <div style="font-weight: 600; margin-bottom: 5px;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</div>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üë§ ${apt.client_email || 'Cliente'}</div>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 10px;">${apt.services || 'Sem servi√ßos'}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="acceptAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')">‚úÖ Aceitar</button>
                                <button class="btn btn-danger" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="rejectAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')">‚ùå Recusar</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('pendingAppointments').innerHTML = '<p style="color: #0f0; text-align: center; padding: 20px;">‚úÖ Nenhum agendamento pendente</p>';
            }
        }
        
        // FUN√á√ÉO PARA CARREGAR AGENDAMENTOS DA PLANILHA GOOGLE SHEETS
        async function loadAppointments() {
            // Mostrar loading
            const listEl = document.getElementById('appointmentsList');
            if (!listEl) {
                console.error('‚ùå Elemento appointmentsList n√£o encontrado');
                return;
            }
            
            listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Carregando agendamentos...</p>';
            
            try {
                // ========================================
                // BARBEREIRAS = SUPABASE (tabela barbershops)
                // ========================================
                // PRIMEIRO: Buscar informa√ß√µes da barbearia do SUPABASE
                if (!currentUser || !currentUser.id) {
                    listEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                console.log('üìä Buscando barbearia do Supabase (tabela barbershops) para usu√°rio:', currentUser.id);
                
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shopError) {
                    console.error('‚ùå Erro ao buscar barbearia do Supabase:', shopError);
                    listEl.innerHTML = '<p style="color: #f00;">Erro ao buscar informa√ß√µes da barbearia. <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Cadastre sua barbearia</a></p>';
                    return;
                }
                
                if (!shop || !shop.id || !shop.name) {
                    listEl.innerHTML = '<p style="color: #f00;">‚ö†Ô∏è Cadastre sua barbearia primeiro! <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Ir para cadastro</a></p>';
                    return;
                }
                
                console.log('‚úÖ Barbearia encontrada no Supabase:', shop.name);
                
                // Filtros
                const statusFilter = document.getElementById('filterStatus')?.value || 'all';
                const dateFilter = document.getElementById('filterDate')?.value || 'all';
                const professionalFilter = document.getElementById('filterProfessional')?.value || 'all';
                const searchTerm = (document.getElementById('searchClient')?.value || '').toLowerCase();
                
                // ========================================
                // AGENDAMENTOS = PLANILHA GOOGLE SHEETS
                // ========================================
                // SEGUNDO: Buscar agendamentos da PLANILHA GOOGLE SHEETS
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                
                // Ler dados da planilha (colunas A at√© I - incluindo ID √∫nico e Profissional)
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:I1000?key=${API_KEY}`;
                
                console.log('üìä Buscando agendamentos da planilha...');
                
                let response;
                let data;
                
                try {
                    const fetchPromise = fetch(sheetsUrl);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout ao buscar planilha')), 10000)
                    );
                    
                    response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                    data = await response.json();
                } catch (fetchError) {
                    console.error('‚ùå Erro ao buscar planilha:', fetchError);
                    document.getElementById('appointmentsList').innerHTML = '<p style="color: #f00;">Erro ao carregar agendamentos. Verifique sua conex√£o e tente novamente.</p>';
                    return;
                }
                
                const rows = data.values || [];
                console.log(`‚úÖ ${rows.length} linhas encontradas na planilha`);
                
                // Buscar profissionais para popular o filtro
                let employees = [];
                try {
                    const { data: supabaseEmployees } = await supabase
                        .from('employees')
                        .select('name')
                        .eq('barbershop_id', shop.id)
                        .eq('status', 'Ativo');
                    if (supabaseEmployees) {
                        employees = supabaseEmployees.map(e => e.name);
                    }
                } catch (error) {
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        employees = parsed.filter(e => e.status === 'Ativo').map(e => e.name);
                    }
                }
                
                // Popular select de profissionais
                const professionalSelect = document.getElementById('filterProfessional');
                if (professionalSelect) {
                    professionalSelect.innerHTML = '<option value="all">Todos os Profissionais</option>' +
                        employees.map(emp => `<option value="${emp}">${emp}</option>`).join('');
                }
                
                // Converter linhas da planilha em objetos de agendamento
                let appointments = rows.map((row, index) => {
                    // Formato: Data | Hora | Cliente | Barbearia | Servi√ßos | Observa√ß√µes | Status | ID | Profissional (I)
                    // Na planilha, √†s vezes Status est√° vazio em G e aparece em F (Observa√ß√µes)
                    let status = row[6] || 'Pendente'; // Coluna G primeiro
                    let notes = row[5] || ''; // Coluna F
                    let appointmentId = (row[7] && String(row[7]).trim() !== '') ? String(row[7]).trim() : null; // Coluna H (ID √∫nico)
                    let professional = (row[8] && String(row[8]).trim() !== '') ? String(row[8]).trim() : null; // Coluna I (Profissional)
                    
                    // Log para debug
                    if (!appointmentId) {
                        console.log(`‚ö†Ô∏è Linha ${index + 2} sem ID - ser√° usado fallback (data+hora+email)`);
                    }
                    
                    // Se n√£o tem status em G, verificar se Observa√ß√µes cont√©m status
                    if (!row[6] || row[6].trim() === '') {
                        const notesLower = (notes || '').toLowerCase();
                        if (notesLower === 'pendente' || notesLower.includes('pendente') && !notesLower.includes('servi√ßos')) {
                            status = 'Pendente';
                            notes = ''; // Limpar notes se era s√≥ o status
                        } else if (notesLower.includes('confirmado')) {
                            status = 'Confirmado';
                            notes = notes.replace(/confirmado/gi, '').trim();
                        } else if (notesLower.includes('recusado') || notesLower.includes('rejeitado')) {
                            status = 'Recusado';
                        } else if (notesLower.includes('conclu√≠do') || notesLower.includes('concluido')) {
                            status = 'Conclu√≠do';
                        } else if (notesLower.includes('cancelado')) {
                            status = 'Cancelado';
                        } else {
                            status = 'Pendente'; // Padr√£o
                        }
                    }
                    
                    return {
                        id: `sheet_${index + 2}`, // +2 porque linha real na planilha √© A2, A3, etc
                        appointment_id: appointmentId, // ID √∫nico da coluna H
                        appointment_date: row[0] || '',
                        appointment_time: row[1] || '',
                        client_email: row[2] || '',
                        barbershop_name: row[3] || '',
                        services: row[4] || '',
                        notes: notes,
                        professional: professional, // Coluna I - Profissional
                        status: status.toLowerCase()
                            .replace('pendente', 'pending')
                            .replace('confirmado', 'confirmed')
                            .replace('recusado', 'rejected')
                            .replace('rejeitado', 'rejected')
                            .replace('conclu√≠do', 'completed')
                            .replace('concluido', 'completed')
                            .replace('cancelado', 'cancelled')
                            .trim() || 'pending'
                    };
                }).filter(apt => apt.appointment_date && apt.appointment_time);
                
                console.log(`üìã ${appointments.length} agendamentos processados:`, appointments);
                
                // Filtrar agendamentos da planilha usando nome da barbearia do Supabase
                // (Usa informa√ß√µes do Supabase para filtrar dados da planilha)
                if (!shop || !shop.name) {
                    listEl.innerHTML = '<p style="color: #f00;">Informa√ß√µes da barbearia incompletas</p>';
                    return;
                }
                
                console.log('üîç Filtrando agendamentos da planilha usando nome da barbearia do Supabase:', shop.name);
                appointments = appointments.filter(apt => {
                    if (!apt.barbershop_name) return false;
                    const aptName = apt.barbershop_name.toLowerCase().trim();
                    const shopName = shop.name.toLowerCase().trim();
                    const matchesShop = aptName === shopName || 
                           aptName.includes(shopName) || 
                           shopName.includes(aptName);
                    
                    // N√£o mostrar agendamentos que foram processados recentemente
                    const wasProcessed = isAppointmentProcessed(apt.id);
                    
                    return matchesShop && !wasProcessed;
                });
                
                console.log(`‚úÖ ${appointments.length} agendamentos da planilha encontrados para barbearia "${shop.name}" do Supabase`);
                
                // Aplicar filtros
                if (statusFilter !== 'all') {
                    appointments = appointments.filter(apt => apt.status === statusFilter);
                }
                
                if (dateFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    appointments = appointments.filter(apt => apt.appointment_date === today);
                } else if (dateFilter === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    appointments = appointments.filter(apt => apt.appointment_date >= weekAgo.toISOString().split('T')[0]);
                } else if (dateFilter === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    appointments = appointments.filter(apt => apt.appointment_date >= monthAgo.toISOString().split('T')[0]);
                }
                
                // Filtrar por profissional
                if (professionalFilter !== 'all') {
                    appointments = appointments.filter(apt => 
                        apt.professional && apt.professional.toLowerCase() === professionalFilter.toLowerCase()
                    );
                }
                
                // Filtrar por busca de cliente
                if (searchTerm) {
                    appointments = appointments.filter(apt => 
                        (apt.client_email || '').toLowerCase().includes(searchTerm)
                    );
                }
                
                if (!appointments || appointments.length === 0) {
                    document.getElementById('appointmentsList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Nenhum agendamento encontrado</p>';
                    return;
                }
                
                // Renderizar agendamentos
                document.getElementById('appointmentsList').innerHTML = appointments.map(apt => {
                    const statusColors = {
                        pending: { bg: 'rgba(255,152,0,0.2)', color: '#ff9800', text: '‚è≥ Pendente' },
                        confirmed: { bg: 'rgba(0,255,0,0.2)', color: '#0f0', text: '‚úÖ Confirmado' },
                        rejected: { bg: 'rgba(255,0,0,0.2)', color: '#f00', text: '‚ùå Recusado' },
                        completed: { bg: 'rgba(0,0,255,0.2)', color: '#00f', text: '‚úÖ Conclu√≠do' },
                        cancelled: { bg: 'rgba(128,128,128,0.2)', color: '#888', text: 'üö´ Cancelado' }
                    };
                    const status = statusColors[apt.status] || statusColors.pending;
                    
                    return `
                        <div data-appointment-id="${apt.id}" style="background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: opacity 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">üë§ ${apt.client_email || 'Cliente'}</div>
                                    <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üìß ${apt.client_email || 'Email n√£o dispon√≠vel'}</div>
                                    <div style="color: #999; font-size: 0.9rem;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</div>
                                    ${apt.professional ? `<div style="color: #e50914; font-size: 0.9rem; margin-top: 5px;">üë®‚Äçüíº Profissional: ${apt.professional}</div>` : '<div style="color: #999; font-size: 0.85rem; margin-top: 5px; font-style: italic;">‚ö†Ô∏è Profissional n√£o definido</div>'}
                                    ${apt.services ? `<div style="color: #e50914; font-size: 0.9rem; margin-top: 5px;">üíá ${apt.services}</div>` : ''}
                                </div>
                                <span style="padding: 5px 15px; background: ${status.bg}; color: ${status.color}; border-radius: 5px; font-size: 0.85rem; font-weight: 600;">
                                    ${status.text}
                                </span>
                            </div>
                            
                            ${apt.notes ? `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-bottom: 15px; color: #ccc;">
                                <strong>Observa√ß√µes:</strong> ${apt.notes}
                            </div>` : ''}
                            
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${apt.status === 'pending' ? `
                                    <button class="btn" onclick="acceptAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚úÖ Aceitar</button>
                                    <button class="btn btn-danger" onclick="rejectAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚ùå Recusar</button>
                                ` : ''}
                                ${apt.status === 'confirmed' ? `
                                    <button class="btn" onclick="completeAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚úÖ Marcar como Conclu√≠do</button>
                                    <button class="btn btn-danger" onclick="cancelAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">üö´ Cancelar</button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="viewAppointmentDetails('${apt.id}')" style="width: 100%;">üëÅÔ∏è Ver Detalhes</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                document.getElementById('appointmentsList').innerHTML = `<p style="color: #f00;">Erro: ${error.message}</p>`;
            }
        }
        
        // ========================================
        // SISTEMA DE RATE LIMITING PARA GOOGLE APPS SCRIPT
        // ========================================
        let requestQueue = [];
        let isProcessingQueue = false;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 2000; // 2 segundos entre requisi√ß√µes (evita 429)
        const MAX_RETRIES = 3;
        const RETRY_DELAY_BASE = 5000; // 5 segundos base para retry
        
        // Processar fila de requisi√ß√µes
        async function processRequestQueue() {
            if (isProcessingQueue || requestQueue.length === 0) return;
            
            isProcessingQueue = true;
            
            while (requestQueue.length > 0) {
                const request = requestQueue[0];
                
                // Aguardar intervalo m√≠nimo entre requisi√ß√µes
                const timeSinceLastRequest = Date.now() - lastRequestTime;
                if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                    const waitTime = MIN_REQUEST_INTERVAL - timeSinceLastRequest;
                    console.log(`‚è≥ Aguardando ${waitTime}ms antes da pr√≥xima requisi√ß√£o...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                try {
                    await executeRequest(request);
                    requestQueue.shift(); // Remover da fila se sucesso
                    lastRequestTime = Date.now();
                    updateQueueIndicator(); // Atualizar indicador visual
                } catch (error) {
                    request.retries = (request.retries || 0) + 1;
                    
                    if (request.retries >= MAX_RETRIES) {
                        console.error(`‚ùå M√°ximo de tentativas atingido para requisi√ß√£o:`, request);
                        requestQueue.shift(); // Remover da fila ap√≥s max tentativas
                        updateQueueIndicator(); // Atualizar indicador visual
                        if (request.onError) request.onError(error);
                    } else {
                        // Retry com backoff exponencial
                        const retryDelay = RETRY_DELAY_BASE * Math.pow(2, request.retries - 1);
                        console.log(`üîÑ Tentativa ${request.retries}/${MAX_RETRIES} falhou. Retry em ${retryDelay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        // Manter na fila para retry
                    }
                }
            }
            
            isProcessingQueue = false;
        }
        
        // Executar requisi√ß√£o individual
        async function executeRequest(request) {
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxTlKNLE6vQu_J2tiVUVm52N2JApGxmmNNHamQs1OgxFKdY_8rTO7rUVz4JasCrpa91yQ/exec';
            
            console.log('üì§ Enviando requisi√ß√£o ao Google Apps Script...', request.updateData);
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request.updateData)
                });
                
                // Com no-cors n√£o conseguimos ler status, mas assumimos sucesso
                console.log('‚úÖ Requisi√ß√£o enviada com sucesso!');
                
                if (request.onSuccess) {
                    request.onSuccess();
                }
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                throw error;
            }
        }
        
        // Adicionar requisi√ß√£o √† fila
        function queueRequest(updateData, onSuccess, onError) {
            requestQueue.push({
                updateData,
                onSuccess,
                onError,
                retries: 0
            });
            
            updateQueueIndicator(); // Atualizar indicador visual
            processRequestQueue();
        }
        
        // FUN√á√ïES PARA ATUALIZAR STATUS NA PLANILHA
        async function acceptAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Confirmar este agendamento?')) return;
            
            // Remover item da interface imediatamente (otimistic update)
            removeAppointmentFromUI(id);
            
            // Desabilitar bot√µes durante processamento
            disableAppointmentButtons(id);
            await updateAppointmentStatusInSheet(date, time, 'Confirmado', '', clientEmail, barbershopName, appointmentId);
        }
        
        async function rejectAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            const reason = prompt('Motivo da recusa (opcional):');
            if (reason === null) return;
            
            // Remover item da interface imediatamente (otimistic update)
            removeAppointmentFromUI(id);
            
            disableAppointmentButtons(id);
            await updateAppointmentStatusInSheet(date, time, 'Cancelado', reason, clientEmail, barbershopName, appointmentId);
        }
        
        // Armazenar IDs de agendamentos que foram aceitos/recusados (para n√£o mostrar novamente at√© confirmar atualiza√ß√£o)
        const processedAppointments = new Set();
        
        // Remover agendamento da interface imediatamente
        function removeAppointmentFromUI(id) {
            // Marcar como processado
            processedAppointments.add(id);
            
            // Remover do dashboard (se√ß√£o de pendentes)
            const pendingContainer = document.getElementById('pendingAppointments');
            if (pendingContainer) {
                const appointmentElement = pendingContainer.querySelector(`[data-appointment-id="${id}"]`);
                if (appointmentElement) {
                    appointmentElement.style.transition = 'opacity 0.3s';
                    appointmentElement.style.opacity = '0';
                    appointmentElement.style.pointerEvents = 'none';
                    setTimeout(() => {
                        appointmentElement.remove();
                        // Se n√£o h√° mais pendentes, mostrar mensagem
                        if (pendingContainer.children.length === 0 || 
                            (pendingContainer.children.length === 1 && pendingContainer.children[0].tagName === 'P')) {
                            pendingContainer.innerHTML = '<p style="color: #0f0; text-align: center; padding: 20px;">‚úÖ Nenhum agendamento pendente</p>';
                        }
                    }, 300);
                }
            }
            
            // Remover da lista de agendamentos
            const appointmentsList = document.getElementById('appointmentsList');
            if (appointmentsList) {
                const appointmentElement = appointmentsList.querySelector(`[data-appointment-id="${id}"]`);
                if (appointmentElement) {
                    appointmentElement.style.transition = 'opacity 0.3s';
                    appointmentElement.style.opacity = '0';
                    appointmentElement.style.pointerEvents = 'none';
                    setTimeout(() => {
                        appointmentElement.remove();
                    }, 300);
                }
            }
        }
        
        // Verificar se agendamento foi processado (para n√£o mostrar novamente)
        function isAppointmentProcessed(id) {
            return processedAppointments.has(id);
        }
        
        // Limpar lista de processados ap√≥s confirmar atualiza√ß√£o na planilha
        function clearProcessedAppointments() {
            processedAppointments.clear();
        }
        
        async function completeAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Marcar como conclu√≠do?')) return;
            
            disableAppointmentButtons(id);
            await updateAppointmentStatusInSheet(date, time, 'Conclu√≠do', '', clientEmail, barbershopName, appointmentId);
        }
        
        async function cancelAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Cancelar este agendamento?')) return;
            
            disableAppointmentButtons(id);
            await updateAppointmentStatusInSheet(date, time, 'Cancelado', '', clientEmail, barbershopName, appointmentId);
        }
        
        // Desabilitar bot√µes durante processamento
        function disableAppointmentButtons(id) {
            // Desabilitar todos os bot√µes de a√ß√£o de agendamento
            const allButtons = document.querySelectorAll('.btn');
            allButtons.forEach(btn => {
                if (btn.textContent.includes('Aceitar') || 
                    btn.textContent.includes('Recusar') || 
                    btn.textContent.includes('Conclu√≠do') || 
                    btn.textContent.includes('Cancelar')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.dataset.originalText = btn.textContent;
                    btn.textContent = '‚è≥ Processando...';
                }
            });
        }
        
        // Reabilitar bot√µes ap√≥s processamento
        function enableAppointmentButtons(id) {
            const allButtons = document.querySelectorAll('.btn');
            allButtons.forEach(btn => {
                if (btn.dataset.originalText) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.textContent = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                }
            });
        }
        
        // Fun√ß√£o para atualizar status na planilha (com rate limiting)
        async function updateAppointmentStatusInSheet(date, time, newStatus, reason = '', clientEmail = '', barbershopName = '', appointmentId = null) {
            try {
                // CR√çTICO: action: 'updateStatus' DEVE estar presente para atualizar linha existente
                const updateData = {
                    action: 'updateStatus',
                    appointment_id: appointmentId || null,
                    appointment_date: date,
                    appointment_time: time,
                    client_email: clientEmail || '',
                    barbershop_name: barbershopName || '',
                    status: newStatus
                };
                
                console.log('üîç Dados para atualizar na planilha:');
                console.log('  - Action:', updateData.action);
                console.log('  - ID:', updateData.appointment_id || 'N√ÉO FORNECIDO (usar√° fallback)');
                console.log('  - Data:', updateData.appointment_date);
                console.log('  - Hora:', updateData.appointment_time);
                console.log('  - Email:', updateData.client_email);
                console.log('  - Barbearia:', updateData.barbershop_name);
                console.log('  - Novo Status:', updateData.status);
                console.log('üì§ JSON completo:', JSON.stringify(updateData));
                
                // Valida√ß√£o
                if (!updateData.appointment_id && (!updateData.appointment_date || !updateData.appointment_time || !updateData.client_email)) {
                    console.error('‚ùå ERRO: Dados insuficientes para atualizar!');
                    showToast('Erro', 'Dados insuficientes para atualizar. Verifique o console.', 'error');
                    enableAppointmentButtons();
                    return;
                }
                
                // Adicionar √† fila com callbacks
                queueRequest(
                    updateData,
                    // onSuccess
                    () => {
                        console.log('‚úÖ Status atualizado na planilha!');
                        console.log('üìä Aguardando propaga√ß√£o da atualiza√ß√£o...');
                        showToast('Sucesso!', `Status atualizado para: ${newStatus}`, 'success');
                        
                        // Invalidar cache para for√ßar atualiza√ß√£o
                        dataCache.appointments = null;
                        dataCache.lastFetch = null;
                        
                        // Aguardar mais tempo para garantir que a planilha foi atualizada
                        setTimeout(() => {
                            // Limpar lista de processados para permitir recarregar
                            clearProcessedAppointments();
                            
                            // Recarregar dados
                            loadAppointments();
                            if (document.getElementById('dashboard')?.classList.contains('active')) {
                                loadBarberDashboard();
                            }
                            enableAppointmentButtons();
                        }, 3000); // Aumentar delay para garantir atualiza√ß√£o
                    },
                    // onError
                    (error) => {
                        console.error('‚ùå Erro ao atualizar:', error);
                        console.error('Dados que falharam:', updateData);
                        showToast('Erro ao atualizar', 'Tente novamente em alguns segundos. O sistema est√° limitando requisi√ß√µes para evitar sobrecarga.', 'error', 6000);
                        enableAppointmentButtons();
                        // Recarregar para mostrar estado real
                        setTimeout(() => {
                            loadAppointments();
                            if (document.getElementById('dashboard')?.classList.contains('active')) {
                                loadBarberDashboard();
                            }
                        }, 1000);
                    }
                );
                
            } catch (error) {
                console.error('Erro ao atualizar planilha:', error);
                showToast('Erro', error.message, 'error');
                enableAppointmentButtons();
            }
        }
        
        // FUN√á√ïES DE A√á√ÉO PARA AGENDAMENTOS
        async function acceptAppointment(appointmentId) {
            if (!confirm('Confirmar este agendamento?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'confirmed' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚úÖ Agendamento confirmado!');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function rejectAppointment(appointmentId) {
            const reason = prompt('Motivo da recusa (opcional):');
            if (reason === null) return; // Usu√°rio cancelou
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ 
                        status: 'rejected',
                        notes: reason ? `RECUSADO: ${reason}` : 'RECUSADO'
                    })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚ùå Agendamento recusado.');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function completeAppointment(appointmentId) {
            if (!confirm('Marcar este agendamento como conclu√≠do?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'completed' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚úÖ Agendamento marcado como conclu√≠do!');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function cancelAppointment(appointmentId) {
            if (!confirm('Cancelar este agendamento?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'cancelled' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('üö´ Agendamento cancelado.');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        function viewAppointmentDetails(appointmentId) {
            alert('Detalhes do agendamento (em desenvolvimento)');
        }
        
        // ========================================
        // FUN√á√ÉO PARA CARREGAR CLIENTES
        // ========================================
        async function loadClients() {
            const listEl = document.getElementById('clientsList');
            if (!listEl) return;
            
            listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;"><span class="loading-spinner"></span> Carregando clientes...</p>';
            
            try {
                if (!currentUser || !currentUser.id) {
                    listEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                // Buscar barbearia
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    listEl.innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                // Buscar agendamentos da planilha para extrair clientes
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                let appointments = [];
                try {
                    const response = await fetch(sheetsUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const rows = data.values || [];
                        
                        appointments = rows.map((row, index) => ({
                            client_email: row[2] || '',
                            appointment_date: row[0] || '',
                            appointment_time: row[1] || '',
                            services: row[4] || '',
                            status: (row[6] || 'Pendente').toLowerCase(),
                            barbershop_name: row[3] || ''
                        })).filter(apt => 
                            apt.client_email && 
                            apt.barbershop_name.toLowerCase().includes(shop.name.toLowerCase())
                        );
                    }
                } catch (error) {
                    console.error('Erro ao buscar agendamentos:', error);
                }
                
                // Agrupar por cliente
                const clientsMap = new Map();
                appointments.forEach(apt => {
                    const email = apt.client_email.toLowerCase().trim();
                    if (!clientsMap.has(email)) {
                        clientsMap.set(email, {
                            email: apt.client_email,
                            name: apt.client_email.split('@')[0],
                            totalAppointments: 0,
                            confirmedAppointments: 0,
                            totalSpent: 0,
                            lastVisit: '',
                            status: 'Ativo'
                        });
                    }
                    
                    const client = clientsMap.get(email);
                    client.totalAppointments++;
                    
                    if (apt.status === 'confirmado' || apt.status === 'confirmed' || apt.status === 'conclu√≠do' || apt.status === 'completed') {
                        client.confirmedAppointments++;
                        
                        // Extrair pre√ßo dos servi√ßos
                        const priceMatch = apt.services.match(/R\$\s*(\d+[\.,]\d+)/);
                        if (priceMatch) {
                            client.totalSpent += parseFloat(priceMatch[1].replace(',', '.'));
                        }
                    }
                    
                    // √öltima visita
                    const visitDate = apt.appointment_date;
                    if (visitDate && (!client.lastVisit || visitDate > client.lastVisit)) {
                        client.lastVisit = visitDate;
                    }
                });
                
                const clients = Array.from(clientsMap.values()).sort((a, b) => b.totalAppointments - a.totalAppointments);
                
                if (clients.length === 0) {
                    listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Nenhum cliente encontrado ainda.</p>';
                    return;
                }
                
                // Renderizar lista de clientes
                listEl.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #e50914; margin: 0;">Total de Clientes: ${clients.length}</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="searchClients" placeholder="Buscar cliente..." onkeyup="filterClients()" style="padding: 10px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; width: 300px;">
                                <button class="btn" onclick="exportClientsPDF()">
                                    üìÑ Exportar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="clientsListContent">
                        ${clients.map(client => `
                            <div class="form-container" style="margin-bottom: 15px;" data-email="${client.email.toLowerCase()}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                            <div style="width: 50px; height: 50px; border-radius: 50%; background: #e50914; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1.2rem;">
                                                ${client.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">${client.name}</div>
                                                <div style="color: #999; font-size: 0.9rem;">${client.email}</div>
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                                            <div>
                                                <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">Total de Agendamentos</div>
                                                <div style="font-size: 1.2rem; font-weight: 600; color: #e50914;">${client.totalAppointments}</div>
                                            </div>
                                            <div>
                                                <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">Confirmados</div>
                                                <div style="font-size: 1.2rem; font-weight: 600; color: #0f0;">${client.confirmedAppointments}</div>
                                            </div>
                                            <div>
                                                <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">Total Gasto</div>
                                                <div style="font-size: 1.2rem; font-weight: 600; color: #0f0;">R$ ${client.totalSpent.toFixed(2).replace('.', ',')}</div>
                                            </div>
                                            <div>
                                                <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">√öltima Visita</div>
                                                <div style="font-size: 0.9rem; color: #fff;">${client.lastVisit || 'N/A'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                listEl.innerHTML = '<p style="color: #f00;">Erro ao carregar clientes: ' + error.message + '</p>';
            }
        }
        
        function filterClients() {
            const searchTerm = document.getElementById('searchClients')?.value.toLowerCase() || '';
            const cards = document.querySelectorAll('[data-email]');
            
            cards.forEach(card => {
                const email = card.getAttribute('data-email') || '';
                if (email.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // ========================================
        // FUN√á√ÉO PARA CARREGAR FINANCEIRO
        // ========================================
        async function loadFinancial() {
            const contentEl = document.getElementById('financialContent');
            if (!contentEl) return;
            
            contentEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;"><span class="loading-spinner"></span> Carregando dados financeiros...</p>';
            
            try {
                if (!currentUser || !currentUser.id) {
                    contentEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                // Buscar barbearia
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    contentEl.innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                // Buscar agendamentos da planilha
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                let appointments = [];
                try {
                    const response = await fetch(sheetsUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const rows = data.values || [];
                        
                        appointments = rows.map((row, index) => {
                            const services = row[4] || '';
                            const priceMatch = services.match(/R\$\s*(\d+[\.,]\d+)/);
                            const price = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0;
                            
                            return {
                                date: row[0] || '',
                                time: row[1] || '',
                                client: row[2] || '',
                                services: services,
                                price: price,
                                status: (row[6] || 'Pendente').toLowerCase(),
                                barbershop_name: row[3] || ''
                            };
                        }).filter(apt => 
                            apt.barbershop_name.toLowerCase().includes(shop.name.toLowerCase()) &&
                            (apt.status === 'confirmado' || apt.status === 'confirmed' || apt.status === 'conclu√≠do' || apt.status === 'completed')
                        );
                    }
                } catch (error) {
                    console.error('Erro ao buscar agendamentos:', error);
                }
                
                // Calcular estat√≠sticas
                const today = new Date().toISOString().split('T')[0];
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                
                const todayRevenue = appointments
                    .filter(apt => apt.date === today)
                    .reduce((sum, apt) => sum + apt.price, 0);
                
                const weekRevenue = appointments
                    .filter(apt => {
                        const aptDate = new Date(apt.date);
                        return aptDate >= startOfWeek;
                    })
                    .reduce((sum, apt) => sum + apt.price, 0);
                
                const monthRevenue = appointments
                    .filter(apt => {
                        const aptDate = new Date(apt.date);
                        return aptDate >= startOfMonth;
                    })
                    .reduce((sum, apt) => sum + apt.price, 0);
                
                const totalRevenue = appointments.reduce((sum, apt) => sum + apt.price, 0);
                const totalAppointments = appointments.length;
                const avgTicket = totalAppointments > 0 ? totalRevenue / totalAppointments : 0;
                
                // Agrupar por m√™s para gr√°fico
                const monthlyData = {};
                appointments.forEach(apt => {
                    if (apt.date) {
                        const month = apt.date.substring(0, 7); // YYYY-MM
                        if (!monthlyData[month]) {
                            monthlyData[month] = 0;
                        }
                        monthlyData[month] += apt.price;
                    }
                });
                
                const months = Object.keys(monthlyData).sort();
                const revenues = months.map(m => monthlyData[m]);
                
                // Renderizar
                contentEl.innerHTML = `
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #e50914; margin: 0;">üìä Resumo Financeiro</h3>
                    <button class="btn" onclick="exportFinancialPDF()">
                        üìÑ Exportar Relat√≥rio PDF
                    </button>
                </div>
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-value" style="color: #0f0;">R$ ${todayRevenue.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Receita Hoje</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #0f0;">R$ ${weekRevenue.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Receita da Semana</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #0f0;">R$ ${monthRevenue.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Receita do M√™s</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #e50914;">R$ ${totalRevenue.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Receita Total</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-value">${totalAppointments}</div>
                                <div class="stat-label">Total de Servi√ßos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #e50914;">R$ ${avgTicket.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Ticket M√©dio</div>
                            </div>
                        </div>
                        
                        <div class="form-container" style="margin-top: 30px;">
                            <h3 style="color: #e50914; margin-bottom: 20px;">üìà Receitas por M√™s</h3>
                            <div style="display: flex; align-items: end; gap: 10px; height: 200px; margin-top: 20px;">
                                ${months.map((month, index) => {
                                    const maxRevenue = Math.max(...revenues);
                                    const height = maxRevenue > 0 ? (revenues[index] / maxRevenue) * 100 : 0;
                                    return `
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                            <div style="width: 100%; background: rgba(229, 9, 20, 0.2); border-radius: 5px 5px 0 0; position: relative; min-height: 150px; display: flex; align-items: end;">
                                                <div style="width: 100%; background: linear-gradient(to top, #e50914, #f40612); height: ${height}%; border-radius: 5px 5px 0 0; transition: all 0.3s;"></div>
                                                <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; color: #999; white-space: nowrap;">
                                                    R$ ${revenues[index].toFixed(0)}
                                                </div>
                                            </div>
                                            <div style="font-size: 0.75rem; color: #999; margin-top: 30px; text-align: center;">
                                                ${new Date(month + '-01').toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' })}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="form-container" style="margin-top: 30px;">
                            <h3 style="color: #e50914; margin-bottom: 20px;">üí∞ √öltimas Transa√ß√µes</h3>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${appointments.slice(-20).reverse().map(apt => `
                                    <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; margin-bottom: 5px;">${apt.client || 'Cliente'}</div>
                                            <div style="color: #999; font-size: 0.9rem;">${apt.date} ${apt.time} - ${apt.services}</div>
                                        </div>
                                        <div style="font-size: 1.2rem; font-weight: 600; color: #0f0;">
                                            R$ ${apt.price.toFixed(2).replace('.', ',')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erro ao carregar financeiro:', error);
                contentEl.innerHTML = '<p style="color: #f00;">Erro ao carregar dados financeiros: ' + error.message + '</p>';
            }
        }
        
        // ========================================
        // FUN√á√ÉO PARA CARREGAR FUNCION√ÅRIOS/PROFISSIONAIS
        // ========================================
        async function loadEmployees() {
            const listEl = document.getElementById('employeesList');
            if (!listEl) return;
            
            listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;"><span class="loading-spinner"></span> Carregando funcion√°rios...</p>';
            
            try {
                if (!currentUser || !currentUser.id) {
                    listEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                // Buscar barbearia
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    listEl.innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                // Buscar funcion√°rios do Supabase (se a tabela existir) ou usar localStorage
                let employees = [];
                try {
                    const { data: supabaseEmployees } = await supabase
                        .from('employees')
                        .select('*')
                        .eq('barbershop_id', shop.id)
                        .order('name', { ascending: true });
                    
                    if (supabaseEmployees) {
                        employees = supabaseEmployees;
                    }
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    if (stored) {
                        employees = JSON.parse(stored);
                    }
                }
                
                // Renderizar
                listEl.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <div class="form-container" style="margin-bottom: 30px;">
                            <h3 style="color: #e50914; margin-bottom: 20px;">‚ûï Adicionar Novo Profissional</h3>
                            <div id="employeeAlert" class="alert"></div>
                            <form id="employeeForm" onsubmit="handleAddEmployee(event)">
                                <h4 style="color: #e50914; margin: 20px 0 15px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">üìã Dados Pessoais</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Nome Completo *</label>
                                        <input type="text" id="employeeName" required placeholder="Ex: Jo√£o Silva">
                                    </div>
                                    <div class="form-group">
                                        <label>Email de Contato *</label>
                                        <input type="email" id="employeeEmail" required placeholder="joao@email.com">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Telefone *</label>
                                        <input type="tel" id="employeePhone" required placeholder="(00) 00000-0000">
                                    </div>
                                    <div class="form-group">
                                        <label>WhatsApp *</label>
                                        <input type="tel" id="employeeWhatsapp" required placeholder="(00) 00000-0000">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Especialidade</label>
                                        <input type="text" id="employeeSpecialty" placeholder="Ex: Corte, Barba, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label>Data de Contrata√ß√£o *</label>
                                        <input type="date" id="employeeHireDate" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="employeeStatus" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                        <option value="F√©rias">F√©rias</option>
                                        <option value="Licen√ßa">Licen√ßa</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Observa√ß√µes</label>
                                    <textarea id="employeeNotes" rows="3" placeholder="Informa√ß√µes adicionais sobre o profissional"></textarea>
                                </div>
                                
                                <h4 style="color: #e50914; margin: 20px 0 15px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">üîê Dados de Acesso</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Email para Login *</label>
                                        <input type="email" id="employeeLoginEmail" required placeholder="login@email.com">
                                        <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Email que o profissional usar√° para acessar o painel</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Senha *</label>
                                        <input type="password" id="employeePassword" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                                        <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Senha para acesso ao painel do profissional</small>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn">Adicionar Profissional</button>
                            </form>
                        </div>
                        
                        <div class="form-container">
                            <h3 style="color: #e50914; margin-bottom: 20px;">üë• Lista de Profissionais (${employees.length})</h3>
                            ${employees.length === 0 ? 
                                '<p style="color: #999; text-align: center; padding: 40px;">Nenhum profissional cadastrado ainda.</p>' :
                                `
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                                    ${employees.map((emp, index) => {
                                        const statusColors = {
                                            'Ativo': { bg: 'rgba(0,255,0,0.2)', color: '#0f0' },
                                            'Inativo': { bg: 'rgba(255,0,0,0.2)', color: '#f00' },
                                            'F√©rias': { bg: 'rgba(255,152,0,0.2)', color: '#ff9800' },
                                            'Licen√ßa': { bg: 'rgba(128,128,128,0.2)', color: '#888' }
                                        };
                                        const statusStyle = statusColors[emp.status] || statusColors['Ativo'];
                                        
                                        return `
                                            <div class="form-container" style="margin-bottom: 0;">
                                                <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 15px;">
                                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: #e50914; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1.5rem; flex-shrink: 0;">
                                                        ${emp.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">${emp.name}</div>
                                                        <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üìß ${emp.email}</div>
                                                        <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üì± ${emp.whatsapp || emp.phone || 'N/A'}</div>
                                                        <div style="color: #e50914; font-size: 0.85rem;">üîê Login: ${emp.login_email || 'N/A'}</div>
                                                    </div>
                                                </div>
                                                ${emp.specialty ? `<div style="margin-bottom: 10px;"><span style="color: #e50914; font-size: 0.9rem;">üéØ ${emp.specialty}</span></div>` : ''}
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                    <div>
                                                        <div style="color: #999; font-size: 0.85rem; margin-bottom: 5px;">Contratado em</div>
                                                        <div style="font-size: 0.9rem;">${emp.hire_date || 'N/A'}</div>
                                                    </div>
                                                    <span style="padding: 5px 12px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 5px; font-size: 0.85rem; font-weight: 600;">
                                                        ${emp.status || 'Ativo'}
                                                    </span>
                                                </div>
                                                ${emp.notes ? `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-bottom: 15px; color: #ccc; font-size: 0.9rem;">${emp.notes}</div>` : ''}
                                                <div style="display: flex; gap: 10px;">
                                                    <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 0.9rem;" onclick="editEmployee(${index})">‚úèÔ∏è Editar</button>
                                                    <button class="btn btn-danger" style="flex: 1; padding: 8px; font-size: 0.9rem;" onclick="deleteEmployee(${index})">üóëÔ∏è Remover</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                `
                            }
                        </div>
                    </div>
                `;
                
                // Definir data padr√£o como hoje
                const dateInput = document.getElementById('employeeHireDate');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
                
            } catch (error) {
                console.error('Erro ao carregar funcion√°rios:', error);
                listEl.innerHTML = '<p style="color: #f00;">Erro ao carregar funcion√°rios: ' + error.message + '</p>';
            }
        }
        
        async function handleAddEmployee(e) {
            e.preventDefault();
            const alert = document.getElementById('employeeAlert');
            
            try {
                if (!currentUser || !currentUser.id) {
                    showAlert(alert, 'Erro: Voc√™ precisa estar logado.', 'error');
                    return;
                }
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) throw new Error('Cadastre sua barbearia primeiro!');
                
                // Hash da senha (usando bcrypt simples ou armazenar hash no Supabase)
                // Por enquanto, vamos armazenar a senha (em produ√ß√£o, usar hash!)
                const password = document.getElementById('employeePassword').value;
                
                // Criar hash simples (em produ√ß√£o, usar bcrypt no backend!)
                // Por seguran√ßa, vamos criar um hash b√°sico
                const passwordHash = btoa(password).split('').reverse().join(''); // Hash b√°sico (N√ÉO SEGURO - apenas exemplo)
                
                const employee = {
                    name: document.getElementById('employeeName').value,
                    email: document.getElementById('employeeEmail').value,
                    phone: document.getElementById('employeePhone').value,
                    whatsapp: document.getElementById('employeeWhatsapp').value,
                    specialty: document.getElementById('employeeSpecialty').value || null,
                    hire_date: document.getElementById('employeeHireDate').value,
                    status: document.getElementById('employeeStatus').value,
                    notes: document.getElementById('employeeNotes').value || null,
                    login_email: document.getElementById('employeeLoginEmail').value,
                    password_hash: passwordHash, // Em produ√ß√£o, usar bcrypt!
                    barbershop_id: shop.id
                };
                
                // Validar senha
                if (password.length < 6) {
                    throw new Error('A senha deve ter no m√≠nimo 6 caracteres');
                }
                
                // Validar email de login √∫nico
                if (employee.login_email === employee.email) {
                    // Se for o mesmo email, est√° ok
                }
                
                // Tentar salvar no Supabase primeiro
                try {
                    const { error } = await supabase.from('employees').insert(employee);
                    if (error) {
                        if (error.message.includes('duplicate') || error.message.includes('unique')) {
                            throw new Error('Este email de login j√° est√° em uso. Escolha outro.');
                        }
                        throw error;
                    }
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    let employees = stored ? JSON.parse(stored) : [];
                    
                    // Verificar se login_email j√° existe
                    const emailExists = employees.some(e => e.login_email === employee.login_email);
                    if (emailExists) {
                        throw new Error('Este email de login j√° est√° em uso. Escolha outro.');
                    }
                    
                    employees.push({ ...employee, id: Date.now() });
                    localStorage.setItem(`employees_${shop.id}`, JSON.stringify(employees));
                }
                
                showToast('Sucesso!', 'Profissional adicionado com sucesso', 'success');
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeHireDate').value = new Date().toISOString().split('T')[0];
                loadEmployees();
                
            } catch (error) {
                showAlert(alert, error.message, 'error');
            }
        }
        
        async function editEmployee(index) {
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) return;
                
                let employees = [];
                try {
                    const { data } = await supabase
                        .from('employees')
                        .select('*')
                        .eq('barbershop_id', shop.id);
                    if (data) employees = data;
                } catch (error) {
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    if (stored) employees = JSON.parse(stored);
                }
                
                const employee = employees[index];
                if (!employee) return;
                
                // Preencher formul√°rio
                document.getElementById('employeeName').value = employee.name || '';
                document.getElementById('employeeEmail').value = employee.email || '';
                document.getElementById('employeePhone').value = employee.phone || '';
                document.getElementById('employeeWhatsapp').value = employee.whatsapp || '';
                document.getElementById('employeeSpecialty').value = employee.specialty || '';
                document.getElementById('employeeHireDate').value = employee.hire_date || '';
                document.getElementById('employeeStatus').value = employee.status || 'Ativo';
                document.getElementById('employeeNotes').value = employee.notes || '';
                document.getElementById('employeeLoginEmail').value = employee.login_email || '';
                // N√£o preencher senha por seguran√ßa
                
                // Modificar fun√ß√£o de submit para editar
                const form = document.getElementById('employeeForm');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const updatedEmployee = {
                        name: document.getElementById('employeeName').value,
                        email: document.getElementById('employeeEmail').value,
                        phone: document.getElementById('employeePhone').value,
                        whatsapp: document.getElementById('employeeWhatsapp').value,
                        specialty: document.getElementById('employeeSpecialty').value || null,
                        hire_date: document.getElementById('employeeHireDate').value,
                        status: document.getElementById('employeeStatus').value,
                        notes: document.getElementById('employeeNotes').value || null,
                        login_email: document.getElementById('employeeLoginEmail').value
                    };
                    
                    // Se senha foi preenchida, atualizar tamb√©m
                    const newPassword = document.getElementById('employeePassword').value;
                    if (newPassword && newPassword.length >= 6) {
                        const passwordHash = btoa(newPassword).split('').reverse().join('');
                        updatedEmployee.password_hash = passwordHash;
                    }
                    
                    try {
                        if (employee.id) {
                            await supabase.from('employees').update(updatedEmployee).eq('id', employee.id);
                        } else {
                            const stored = localStorage.getItem(`employees_${shop.id}`);
                            let employees = stored ? JSON.parse(stored) : [];
                            employees[index] = { ...employees[index], ...updatedEmployee };
                            localStorage.setItem(`employees_${shop.id}`, JSON.stringify(employees));
                        }
                        
                        showToast('Sucesso!', 'Profissional atualizado', 'success');
                        form.onsubmit = handleAddEmployee;
                        form.reset();
                        loadEmployees();
                    } catch (error) {
                        showToast('Erro', error.message, 'error');
                    }
                };
                
                // Scroll para o formul√°rio
                document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
                showToast('Info', 'Preencha os dados e salve para atualizar', 'info');
                
            } catch (error) {
                showToast('Erro', 'Erro ao editar: ' + error.message, 'error');
            }
        }
        
        async function deleteEmployee(index) {
            if (!confirm('Remover este profissional?')) return;
            
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) return;
                
                // Tentar deletar do Supabase
                try {
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    const employees = stored ? JSON.parse(stored) : [];
                    const employee = employees[index];
                    
                    if (employee.id) {
                        await supabase.from('employees').delete().eq('id', employee.id);
                    }
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    let employees = stored ? JSON.parse(stored) : [];
                    employees.splice(index, 1);
                    localStorage.setItem(`employees_${shop.id}`, JSON.stringify(employees));
                }
                
                showToast('Sucesso!', 'Profissional removido', 'success');
                loadEmployees();
                
            } catch (error) {
                showToast('Erro', 'Erro ao remover: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // FUN√á√ïES DE EXPORTA√á√ÉO PDF
        // ========================================
        async function exportEmployeesPDF() {
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    showToast('Erro', 'Cadastre sua barbearia primeiro', 'error');
                    return;
                }
                
                let employees = [];
                try {
                    const { data } = await supabase
                        .from('employees')
                        .select('*')
                        .eq('barbershop_id', shop.id)
                        .order('name', { ascending: true });
                    if (data) employees = data;
                } catch (error) {
                    const stored = localStorage.getItem(`employees_${shop.id}`);
                    if (stored) employees = JSON.parse(stored);
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // T√≠tulo
                doc.setFontSize(18);
                doc.setTextColor(229, 9, 20);
                doc.text('Relat√≥rio de Funcion√°rios', 14, 20);
                
                // Informa√ß√µes da barbearia
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Barbearia: ${shop.name}`, 14, 30);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 36);
                doc.text(`Total de Profissionais: ${employees.length}`, 14, 42);
                
                // Tabela
                const tableData = employees.map(emp => [
                    emp.name || 'N/A',
                    emp.email || 'N/A',
                    emp.phone || 'N/A',
                    emp.specialty || 'N/A',
                    emp.hire_date || 'N/A',
                    emp.status || 'Ativo'
                ]);
                
                doc.autoTable({
                    startY: 50,
                    head: [['Nome', 'Email', 'Telefone', 'Especialidade', 'Contrata√ß√£o', 'Status']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [229, 9, 20] },
                    styles: { fontSize: 9 }
                });
                
                doc.save(`funcionarios_${shop.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('Sucesso!', 'PDF exportado com sucesso', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showToast('Erro', 'Erro ao exportar PDF: ' + error.message, 'error');
            }
        }
        
        async function exportClientsPDF() {
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    showToast('Erro', 'Cadastre sua barbearia primeiro', 'error');
                    return;
                }
                
                // Buscar clientes (mesma l√≥gica do loadClients)
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                let appointments = [];
                try {
                    const response = await fetch(sheetsUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const rows = data.values || [];
                        appointments = rows.map((row) => ({
                            client_email: row[2] || '',
                            appointment_date: row[0] || '',
                            services: row[4] || '',
                            status: (row[6] || 'Pendente').toLowerCase(),
                            barbershop_name: row[3] || ''
                        })).filter(apt => 
                            apt.client_email && 
                            apt.barbershop_name.toLowerCase().includes(shop.name.toLowerCase())
                        );
                    }
                } catch (error) {
                    console.error('Erro ao buscar agendamentos:', error);
                }
                
                // Agrupar por cliente
                const clientsMap = new Map();
                appointments.forEach(apt => {
                    const email = apt.client_email.toLowerCase().trim();
                    if (!clientsMap.has(email)) {
                        clientsMap.set(email, {
                            email: apt.client_email,
                            name: apt.client_email.split('@')[0],
                            totalAppointments: 0,
                            confirmedAppointments: 0,
                            totalSpent: 0
                        });
                    }
                    const client = clientsMap.get(email);
                    client.totalAppointments++;
                    if (apt.status === 'confirmado' || apt.status === 'confirmed' || apt.status === 'conclu√≠do' || apt.status === 'completed') {
                        client.confirmedAppointments++;
                        const priceMatch = apt.services.match(/R\$\s*(\d+[\.,]\d+)/);
                        if (priceMatch) {
                            client.totalSpent += parseFloat(priceMatch[1].replace(',', '.'));
                        }
                    }
                });
                
                const clients = Array.from(clientsMap.values()).sort((a, b) => b.totalAppointments - a.totalAppointments);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.setTextColor(229, 9, 20);
                doc.text('Relat√≥rio de Clientes', 14, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Barbearia: ${shop.name}`, 14, 30);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 36);
                doc.text(`Total de Clientes: ${clients.length}`, 14, 42);
                
                const tableData = clients.map(client => [
                    client.name,
                    client.email,
                    client.totalAppointments.toString(),
                    client.confirmedAppointments.toString(),
                    `R$ ${client.totalSpent.toFixed(2).replace('.', ',')}`
                ]);
                
                doc.autoTable({
                    startY: 50,
                    head: [['Nome', 'Email', 'Total Agend.', 'Confirmados', 'Total Gasto']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [229, 9, 20] },
                    styles: { fontSize: 9 }
                });
                
                doc.save(`clientes_${shop.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('Sucesso!', 'PDF exportado com sucesso', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showToast('Erro', 'Erro ao exportar PDF: ' + error.message, 'error');
            }
        }
        
        async function exportFinancialPDF() {
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    showToast('Erro', 'Cadastre sua barbearia primeiro', 'error');
                    return;
                }
                
                // Buscar agendamentos (mesma l√≥gica do loadFinancial)
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                let appointments = [];
                try {
                    const response = await fetch(sheetsUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const rows = data.values || [];
                        appointments = rows.map((row) => {
                            const services = row[4] || '';
                            const priceMatch = services.match(/R\$\s*(\d+[\.,]\d+)/);
                            const price = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0;
                            return {
                                date: row[0] || '',
                                time: row[1] || '',
                                client: row[2] || '',
                                services: services,
                                price: price,
                                status: (row[6] || 'Pendente').toLowerCase(),
                                barbershop_name: row[3] || ''
                            };
                        }).filter(apt => 
                            apt.barbershop_name.toLowerCase().includes(shop.name.toLowerCase()) &&
                            (apt.status === 'confirmado' || apt.status === 'confirmed' || apt.status === 'conclu√≠do' || apt.status === 'completed')
                        );
                    }
                } catch (error) {
                    console.error('Erro ao buscar agendamentos:', error);
                }
                
                const today = new Date().toISOString().split('T')[0];
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                
                const todayRevenue = appointments.filter(apt => apt.date === today).reduce((sum, apt) => sum + apt.price, 0);
                const weekRevenue = appointments.filter(apt => new Date(apt.date) >= startOfWeek).reduce((sum, apt) => sum + apt.price, 0);
                const monthRevenue = appointments.filter(apt => new Date(apt.date) >= startOfMonth).reduce((sum, apt) => sum + apt.price, 0);
                const totalRevenue = appointments.reduce((sum, apt) => sum + apt.price, 0);
                const totalAppointments = appointments.length;
                const avgTicket = totalAppointments > 0 ? totalRevenue / totalAppointments : 0;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.setTextColor(229, 9, 20);
                doc.text('Relat√≥rio Financeiro', 14, 20);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Barbearia: ${shop.name}`, 14, 30);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 36);
                
                // Resumo
                doc.setFontSize(14);
                doc.text('Resumo Financeiro', 14, 50);
                doc.setFontSize(11);
                doc.text(`Receita Hoje: R$ ${todayRevenue.toFixed(2).replace('.', ',')}`, 14, 60);
                doc.text(`Receita da Semana: R$ ${weekRevenue.toFixed(2).replace('.', ',')}`, 14, 66);
                doc.text(`Receita do M√™s: R$ ${monthRevenue.toFixed(2).replace('.', ',')}`, 14, 72);
                doc.text(`Receita Total: R$ ${totalRevenue.toFixed(2).replace('.', ',')}`, 14, 78);
                doc.text(`Total de Servi√ßos: ${totalAppointments}`, 14, 84);
                doc.text(`Ticket M√©dio: R$ ${avgTicket.toFixed(2).replace('.', ',')}`, 14, 90);
                
                // √öltimas transa√ß√µes
                const recentTransactions = appointments.slice(-20).reverse();
                const tableData = recentTransactions.map(apt => [
                    apt.date || 'N/A',
                    apt.client || 'N/A',
                    apt.services.substring(0, 30) || 'N/A',
                    `R$ ${apt.price.toFixed(2).replace('.', ',')}`
                ]);
                
                doc.autoTable({
                    startY: 100,
                    head: [['Data', 'Cliente', 'Servi√ßo', 'Valor']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [229, 9, 20] },
                    styles: { fontSize: 8 }
                });
                
                doc.save(`relatorio_financeiro_${shop.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('Sucesso!', 'Relat√≥rio PDF exportado com sucesso', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showToast('Erro', 'Erro ao exportar PDF: ' + error.message, 'error');
            }
        }
        
        // ========================================
        // FUN√á√ÉO PARA CARREGAR DESPESAS
        // ========================================
        async function loadExpenses() {
            const listEl = document.getElementById('expensesList');
            if (!listEl) return;
            
            listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;"><span class="loading-spinner"></span> Carregando despesas...</p>';
            
            try {
                if (!currentUser || !currentUser.id) {
                    listEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                // Buscar barbearia
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    listEl.innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                // Buscar despesas do Supabase (se a tabela existir) ou usar localStorage
                let expenses = [];
                try {
                    // Tentar buscar do Supabase primeiro
                    const { data: supabaseExpenses } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('barbershop_id', shop.id)
                        .order('date', { ascending: false });
                    
                    if (supabaseExpenses) {
                        expenses = supabaseExpenses;
                    }
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`expenses_${shop.id}`);
                    if (stored) {
                        expenses = JSON.parse(stored);
                    }
                }
                
                // Calcular totais
                const today = new Date().toISOString().split('T')[0];
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                
                const todayExpenses = expenses
                    .filter(exp => exp.date === today)
                    .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                
                const monthExpenses = expenses
                    .filter(exp => exp.date >= startOfMonth)
                    .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                
                const totalExpenses = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                
                // Renderizar
                listEl.innerHTML = `
                    <div style="margin-bottom: 30px;">
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-value" style="color: #f00;">R$ ${todayExpenses.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Despesas Hoje</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #f00;">R$ ${monthExpenses.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Despesas do M√™s</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #f00;">R$ ${totalExpenses.toFixed(2).replace('.', ',')}</div>
                                <div class="stat-label">Total de Despesas</div>
                            </div>
                        </div>
                        
                        <div class="form-container" style="margin-bottom: 30px;">
                            <h3 style="color: #e50914; margin-bottom: 20px;">‚ûï Adicionar Nova Despesa</h3>
                            <div id="expenseAlert" class="alert"></div>
                            <form id="expenseForm" onsubmit="handleAddExpense(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Descri√ß√£o *</label>
                                        <input type="text" id="expenseDescription" required placeholder="Ex: Aluguel, Material, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label>Valor *</label>
                                        <input type="number" id="expenseAmount" step="0.01" required placeholder="0.00">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Data *</label>
                                        <input type="date" id="expenseDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Categoria</label>
                                        <select id="expenseCategory" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                                            <option value="Aluguel">Aluguel</option>
                                            <option value="Material">Material</option>
                                            <option value="Sal√°rio">Sal√°rio</option>
                                            <option value="Energia">Energia</option>
                                            <option value="√Ågua">√Ågua</option>
                                            <option value="Internet">Internet</option>
                                            <option value="Outros">Outros</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn">Adicionar Despesa</button>
                            </form>
                        </div>
                        
                        <div class="form-container">
                            <h3 style="color: #e50914; margin-bottom: 20px;">üìã Hist√≥rico de Despesas</h3>
                            ${expenses.length === 0 ? 
                                '<p style="color: #999; text-align: center; padding: 40px;">Nenhuma despesa cadastrada ainda.</p>' :
                                `
                                <div style="max-height: 500px; overflow-y: auto;">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Descri√ß√£o</th>
                                                <th>Categoria</th>
                                                <th>Valor</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${expenses.map((exp, index) => `
                                                <tr>
                                                    <td>${exp.date || 'N/A'}</td>
                                                    <td>${exp.description || 'N/A'}</td>
                                                    <td>${exp.category || 'Outros'}</td>
                                                    <td style="color: #f00; font-weight: 600;">R$ ${parseFloat(exp.amount || 0).toFixed(2).replace('.', ',')}</td>
                                                    <td>
                                                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteExpense(${index})">Remover</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                `
                            }
                        </div>
                    </div>
                `;
                
                // Definir data padr√£o como hoje
                const dateInput = document.getElementById('expenseDate');
                if (dateInput) {
                    dateInput.value = today;
                }
                
            } catch (error) {
                console.error('Erro ao carregar despesas:', error);
                listEl.innerHTML = '<p style="color: #f00;">Erro ao carregar despesas: ' + error.message + '</p>';
            }
        }
        
        async function handleAddExpense(e) {
            e.preventDefault();
            const alert = document.getElementById('expenseAlert');
            
            try {
                if (!currentUser || !currentUser.id) {
                    showAlert(alert, 'Erro: Voc√™ precisa estar logado.', 'error');
                    return;
                }
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) throw new Error('Cadastre sua barbearia primeiro!');
                
                const expense = {
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    category: document.getElementById('expenseCategory').value,
                    barbershop_id: shop.id
                };
                
                // Tentar salvar no Supabase primeiro
                try {
                    const { error } = await supabase.from('expenses').insert(expense);
                    if (error) throw error;
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`expenses_${shop.id}`);
                    let expenses = stored ? JSON.parse(stored) : [];
                    expenses.push({ ...expense, id: Date.now() });
                    localStorage.setItem(`expenses_${shop.id}`, JSON.stringify(expenses));
                }
                
                showToast('Sucesso!', 'Despesa adicionada com sucesso', 'success');
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                loadExpenses();
                
            } catch (error) {
                showAlert(alert, error.message, 'error');
            }
        }
        
        async function deleteExpense(index) {
            if (!confirm('Remover esta despesa?')) return;
            
            try {
                if (!currentUser || !currentUser.id) return;
                
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) return;
                
                // Tentar deletar do Supabase
                try {
                    const stored = localStorage.getItem(`expenses_${shop.id}`);
                    const expenses = stored ? JSON.parse(stored) : [];
                    const expense = expenses[index];
                    
                    if (expense.id) {
                        await supabase.from('expenses').delete().eq('id', expense.id);
                    }
                } catch (error) {
                    // Se n√£o existir tabela, usar localStorage
                    const stored = localStorage.getItem(`expenses_${shop.id}`);
                    let expenses = stored ? JSON.parse(stored) : [];
                    expenses.splice(index, 1);
                    localStorage.setItem(`expenses_${shop.id}`, JSON.stringify(expenses));
                }
                
                showToast('Sucesso!', 'Despesa removida', 'success');
                loadExpenses();
                
            } catch (error) {
                showToast('Erro', 'Erro ao remover despesa: ' + error.message, 'error');
            }
        }
        
        async function loadServices() {
            if (!currentUser || !currentUser.id) {
                console.warn('‚ö†Ô∏è currentUser n√£o dispon√≠vel para loadServices');
                return;
            }
            try {
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    document.getElementById('servicesList').innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                const { data: services } = await supabase
                    .from('services')
                    .select('*')
                    .eq('barbershop_id', shop.id)
                    .order('name');
                
                if (!services || services.length === 0) {
                    document.getElementById('servicesList').innerHTML = '<p style="color: #999;">Nenhum servi√ßo cadastrado.</p>';
                    return;
                }
                
                document.getElementById('servicesList').innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Pre√ßo</th>
                                <th>Dura√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${services.map(s => `
                                <tr>
                                    <td>${s.name}</td>
                                    <td>R$ ${parseFloat(s.price).toFixed(2)}</td>
                                    <td>${s.duration} min</td>
                                    <td><button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteService('${s.id}')">Remover</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('servicesList').innerHTML = '<p style="color: #f00;">Erro: ' + error.message + '</p>';
            }
        }
        
        async function handleAddService(e) {
            e.preventDefault();
            const alert = document.getElementById('serviceAlert');
            
            if (!currentUser || !currentUser.id) {
                showAlert(alert, 'Erro: Voc√™ precisa estar logado.', 'error');
                return;
            }
            
            try {
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) throw new Error('Cadastre sua barbearia primeiro!');
                
                const { error } = await supabase.from('services').insert({
                    barbershop_id: shop.id,
                    name: document.getElementById('serviceName').value,
                    price: parseFloat(document.getElementById('servicePrice').value),
                    duration: parseInt(document.getElementById('serviceDuration').value)
                });
                
                if (error) throw error;
                
                showAlert(alert, 'Servi√ßo adicionado!', 'success');
                document.getElementById('serviceForm').reset();
                loadServices();
            } catch (error) {
                showAlert(alert, error.message, 'error');
            }
        }
        
        async function deleteService(id) {
            if (!confirm('Remover este servi√ßo?')) return;
            try {
                const { error } = await supabase.from('services').delete().eq('id', id);
                if (error) throw error;
                loadServices();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function loadBarberShopForm() {
            if (!currentUser || !currentUser.id) {
                console.warn('‚ö†Ô∏è currentUser n√£o dispon√≠vel para loadBarberShopForm');
                return;
            }
            try {
                // Buscar todas as colunas da barbearia
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id, name, description, address, neighborhood, city, state, zip_code, phone, email, whatsapp, business_hours, cover_image, profile_image, barber_id, owner_profile_id, owner_name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shop) {
                    document.getElementById('shopName').value = shop.name || '';
                    document.getElementById('shopDescription').value = shop.description || '';
                    document.getElementById('shopAddress').value = shop.address || '';
                    document.getElementById('shopNeighborhood').value = shop.neighborhood || '';
                    document.getElementById('shopCity').value = shop.city || '';
                    document.getElementById('shopState').value = shop.state || '';
                    document.getElementById('shopZip').value = shop.zip_code || '';
                    document.getElementById('shopPhone').value = shop.phone || '';
                    document.getElementById('shopEmail').value = shop.email || '';
                    document.getElementById('shopWhatsapp').value = shop.whatsapp || '';
                    
                    // Mostrar fotos se existirem
                    if (shop.cover_image) {
                        document.getElementById('coverPreview').src = shop.cover_image;
                        document.getElementById('coverPreview').style.display = 'block';
                    }
                    
                    if (shop.profile_image) {
                        document.getElementById('profilePreview').src = shop.profile_image;
                        document.getElementById('profilePreview').style.display = 'block';
                    }
                    
                    // Carregar hor√°rios de funcionamento
                    if (shop.business_hours) {
                        const hours = typeof shop.business_hours === 'string' 
                            ? JSON.parse(shop.business_hours) 
                            : shop.business_hours;
                        
                        if (hours && hours.start) {
                            document.getElementById('shopOpenTime').value = hours.start;
                        }
                        if (hours && hours.end) {
                            document.getElementById('shopCloseTime').value = hours.end;
                        }
                        if (hours && hours.interval) {
                            document.getElementById('shopInterval').value = hours.interval;
                        }
                    } else {
                        // Usar valores padr√£o se n√£o houver hor√°rios salvos
                        document.getElementById('shopOpenTime').value = '08:00';
                        document.getElementById('shopCloseTime').value = '19:00';
                        document.getElementById('shopInterval').value = '30';
                    }
                }
            } catch (error) {
                console.error(error);
            }
        }
        
        async function handleRegisterShop(e) {
            e.preventDefault();
            const alert = document.getElementById('registerAlert');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            // Verificar e atualizar currentUser antes de salvar
            if (!currentUser || !currentUser.id) {
                console.log('‚ö†Ô∏è currentUser n√£o definido, buscando sess√£o...');
                try {
                    const { data: { user }, error: sessionError } = await supabase.auth.getUser();
                    if (sessionError) {
                        throw sessionError;
                    }
                    if (user && user.id) {
                        currentUser = user;
                        console.log('‚úÖ currentUser atualizado:', currentUser.id);
                    } else {
                        throw new Error('Usu√°rio n√£o encontrado na sess√£o');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', error);
                    const errorMsg = 'Erro: Voc√™ precisa estar logado para salvar. Fa√ßa login novamente.';
                    if (alert) {
                        showAlert(alert, errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                    return;
                }
            }
            
            // Desabilitar bot√£o e mostrar loading
            if (submitButton) {
                submitButton.disabled = true;
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Salvando...';
                
                try {
                    await handleRegisterShopLogic(alert);
                    submitButton.textContent = originalText;
                } catch (error) {
                    submitButton.textContent = originalText;
                    throw error;
                } finally {
                    submitButton.disabled = false;
                }
            } else {
                await handleRegisterShopLogic(alert);
            }
        }
        
        async function handleRegisterShopLogic(alert) {
            console.log('=== handleRegisterShopLogic INICIADO ===');
            console.log('currentUser:', currentUser);
            console.log('alert element:', alert);
            
            if (!currentUser || !currentUser.id) {
                const errorMsg = 'Erro: Voc√™ precisa estar logado para salvar. Fa√ßa login novamente.';
                console.error('‚ùå currentUser inv√°lido:', currentUser);
                if (alert) {
                    showAlert(alert, errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            const userId = currentUser.id;
            console.log('‚úÖ Usu√°rio v√°lido, ID:', userId);
            
            try {
                // Verificar se j√° existe barbearia
                console.log('Buscando barbearia existente...');
                const { data: existingShop, error: searchError } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', userId)
                    .maybeSingle();
                
                if (searchError) {
                    console.error('‚ùå Erro ao buscar barbearia:', searchError);
                    throw new Error('Erro ao verificar barbearia: ' + searchError.message);
                }
                
                console.log('Barbearia existente:', existingShop);
                
                if (existingShop) {
                    console.log('üîÑ Atualizando barbearia existente...');
                    // Atualizar
                    const openTime = document.getElementById('shopOpenTime').value;
                    const closeTime = document.getElementById('shopCloseTime').value;
                    const interval = parseInt(document.getElementById('shopInterval').value);
                    
                    console.log('‚è∞ Hor√°rios configurados:', { openTime, closeTime, interval });
                    
                    const updateData = {
                        name: document.getElementById('shopName').value,
                        description: document.getElementById('shopDescription').value || null,
                        address: document.getElementById('shopAddress').value,
                        neighborhood: document.getElementById('shopNeighborhood').value,
                        city: document.getElementById('shopCity').value,
                        state: document.getElementById('shopState').value,
                        zip_code: document.getElementById('shopZip').value,
                        phone: document.getElementById('shopPhone').value || null,
                        email: document.getElementById('shopEmail').value || null,
                        whatsapp: document.getElementById('shopWhatsapp').value || null,
                        business_hours: {
                            start: openTime,
                            end: closeTime,
                            interval: interval
                        }
                    };
                    
                    console.log('üì§ Dados para atualizar:', updateData);
                    
                    // Adicionar URLs das imagens se foram atualizadas (colunas opcionais)
                    const coverImage = document.getElementById('coverImage').files[0];
                    const profileImage = document.getElementById('profileImage').files[0];
                    
                    try {
                        if (coverImage) {
                            console.log('üì∑ Fazendo upload da capa...');
                            const coverUrl = await uploadImage(coverImage, `barbershops/${existingShop.id}/cover`);
                            updateData.cover_image = coverUrl;
                        }
                    } catch (imgError) {
                        console.warn('‚ö†Ô∏è Erro ao fazer upload da capa ou coluna n√£o existe:', imgError);
                    }
                    
                    try {
                        if (profileImage) {
                            console.log('üì∑ Fazendo upload do perfil...');
                            const profileUrl = await uploadImage(profileImage, `barbershops/${existingShop.id}/profile`);
                            updateData.profile_image = profileUrl;
                        }
                    } catch (imgError) {
                        console.warn('‚ö†Ô∏è Erro ao fazer upload do perfil ou coluna n√£o existe:', imgError);
                    }
                    
                    console.log('üíæ Salvando no banco...');
                    let { error } = await supabase.from('barbershops').update(updateData).eq('id', existingShop.id);
                    
                    if (error) {
                        console.error('‚ùå Erro do Supabase:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Barbearia atualizada com sucesso!');
                    if (alert) {
                        showAlert(alert, '‚úÖ Barbearia atualizada com sucesso!', 'success');
                    } else {
                        alert('Barbearia atualizada com sucesso!');
                    }
                } else {
                    console.log('üÜï Criando nova barbearia...');
                    // Criar nova
                    const openTime = document.getElementById('shopOpenTime').value;
                    const closeTime = document.getElementById('shopCloseTime').value;
                    const interval = parseInt(document.getElementById('shopInterval').value);
                    
                    console.log('‚è∞ Hor√°rios configurados:', { openTime, closeTime, interval });
                    
                    if (!userId) {
                        throw new Error('ID do usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                    }
                    
                    const insertData = {
                        barber_id: userId,
                        name: document.getElementById('shopName').value,
                        description: document.getElementById('shopDescription').value || null,
                        address: document.getElementById('shopAddress').value,
                        neighborhood: document.getElementById('shopNeighborhood').value,
                        city: document.getElementById('shopCity').value,
                        state: document.getElementById('shopState').value,
                        zip_code: document.getElementById('shopZip').value,
                        phone: document.getElementById('shopPhone').value || null,
                        email: document.getElementById('shopEmail').value || null,
                        whatsapp: document.getElementById('shopWhatsapp').value || null,
                        business_hours: {
                            start: openTime,
                            end: closeTime,
                            interval: interval
                        }
                    };
                    
                    console.log('üì§ Dados para inserir:', insertData);
                    console.log('üíæ Inserindo no banco...');
                    
                    let { data: newShop, error: insertError } = await supabase.from('barbershops').insert(insertData).select().single();
                    
                    if (insertError) {
                        console.error('‚ùå Erro do Supabase ao inserir:', insertError);
                        throw insertError;
                    }
                    
                    console.log('‚úÖ Barbearia criada! ID:', newShop?.id);
                    
                    // Upload de imagens se foram selecionadas
                    const coverImage = document.getElementById('coverImage').files[0];
                    const profileImage = document.getElementById('profileImage').files[0];
                    
                    if (coverImage && newShop) {
                        try {
                            console.log('üì∑ Fazendo upload da capa...');
                            const coverUrl = await uploadImage(coverImage, `barbershops/${newShop.id}/cover`);
                            const { error: updateImgError } = await supabase.from('barbershops').update({ cover_image: coverUrl }).eq('id', newShop.id);
                            
                            if (updateImgError) {
                                throw updateImgError;
                            }
                            console.log('‚úÖ Capa atualizada');
                        } catch (imgError) {
                            console.error('‚ùå Erro ao fazer upload da capa:', imgError);
                            throw imgError;
                        }
                    }
                    
                    if (profileImage && newShop) {
                        try {
                            console.log('üì∑ Fazendo upload do perfil...');
                            const profileUrl = await uploadImage(profileImage, `barbershops/${newShop.id}/profile`);
                            const { error: updateImgError } = await supabase.from('barbershops').update({ profile_image: profileUrl }).eq('id', newShop.id);
                            
                            if (updateImgError) {
                                throw updateImgError;
                            }
                            console.log('‚úÖ Perfil atualizado');
                        } catch (imgError) {
                            console.error('‚ùå Erro ao fazer upload do perfil:', imgError);
                            throw imgError;
                        }
                    }
                    
                    console.log('‚úÖ Barbearia criada com sucesso!');
                    if (alert) {
                        showAlert(alert, '‚úÖ Barbearia criada com sucesso!', 'success');
                    } else {
                        alert('Barbearia criada com sucesso!');
                    }
                }
                
                loadBarberDashboard();
            } catch (error) {
                console.error('‚ùå Erro ao salvar barbearia:', error);
                console.error('Detalhes:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                let errorMessage = error.message || 'Erro desconhecido ao salvar';
                
                // Mensagens mais amig√°veis
                if (error.message && error.message.includes('permission') || error.message.includes('RLS')) {
                    errorMessage = 'Erro de permiss√£o. Verifique se voc√™ est√° logado corretamente.';
                } else if (error.message && error.message.includes('foreign key')) {
                    errorMessage = 'Erro ao salvar. Verifique se todos os campos obrigat√≥rios est√£o preenchidos.';
                } else if (error.message && error.message.includes('duplicate')) {
                    errorMessage = 'J√° existe uma barbearia com estes dados.';
                }
                
                if (alert) {
                    showAlert(alert, '‚ùå ' + errorMessage, 'error');
                } else {
                    alert('Erro: ' + errorMessage);
                }
            }
        }
        
        function showAlert(element, message, type) {
            if (!element) {
                console.error('‚ùå Elemento de alerta n√£o encontrado!');
                alert(message); // Fallback para alert nativo
                return;
            }
            
            console.log('üì¢ Mostrando alerta:', { message, type, element: !!element });
            
            element.textContent = message;
            element.className = `alert alert-${type} show`;
            element.style.display = 'block';
            element.style.visibility = 'visible';
            element.style.opacity = '1';
            
            // Scroll para o alerta se necess√°rio
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-ocultar ap√≥s 5 segundos (apenas para sucesso)
            if (type === 'success') {
                setTimeout(() => {
                    if (element) {
                        element.classList.remove('show');
                        setTimeout(() => {
                            if (element) {
                                element.style.display = 'none';
                            }
                        }, 300);
                    }
                }, 5000);
            }
        }
        
        async function uploadImage(file, path) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random()}.${fileExt}`;
            const filePath = `${path}/${fileName}`;
            
            // Verificar se j√° existe arquivo no mesmo path e deletar
            const { data: existingFiles } = await supabase.storage
                .from('barbershops')
                .list(path, { limit: 100 });
            
            if (existingFiles && existingFiles.length > 0) {
                // Deletar arquivos antigos do mesmo tipo
                const filesToDelete = existingFiles.map(f => `${path}/${f.name}`);
                await supabase.storage
                    .from('barbershops')
                    .remove(filesToDelete);
            }
            
            // Fazer upload do novo arquivo
            const { error: uploadError } = await supabase.storage
                .from('barbershops')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (uploadError) {
                console.error('Erro no upload:', uploadError);
                throw new Error('Erro ao fazer upload da imagem: ' + uploadError.message);
            }
            
            // Obter URL p√∫blica
            const { data } = supabase.storage
                .from('barbershops')
                .getPublicUrl(filePath);
            
            return data.publicUrl;
        }
        
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function logout() {
            console.log('üîí Fazendo logout...');
            
            // Limpar Realtime subscriptions
            cleanupRealtimeSubscriptions();
            
            // Parar polling
            stopPolling();
            
            try {
                // Fazer logout no Supabase
                await supabase.auth.signOut();
            } catch (err) {
                console.warn('‚ö†Ô∏è Erro no signOut (continuando mesmo assim):', err);
            }
            
            // Limpar dados locais IMEDIATAMENTE
            currentUser = null;
            window.currentUser = null;
            
            // Limpar localStorage e sessionStorage
            try {
                localStorage.clear();
                sessionStorage.clear();
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao limpar storage:', e);
            }
            
            // Esconder conte√∫do do painel
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) {
                mainLayout.style.display = 'none';
            }
            
            // Mostrar tela de login IMEDIATAMENTE
            showLoginScreen();
            
            console.log('‚úÖ Logout conclu√≠do');
        }
        
        // Fun√ß√£o para verificar se h√° hash de reset de senha na URL
        async function checkPasswordReset() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash;
            
            // Verificar se h√° hash de reset do Supabase Auth
            if (hash.includes('type=recovery') || hash.includes('access_token')) {
                // Mostrar formul√°rio de nova senha
                showResetPasswordForm();
                // Limpar hash da URL
                window.history.replaceState(null, '', window.location.pathname);
                return true;
            }
            
            return false;
        }
        
        // Fun√ß√£o para mostrar formul√°rio de nova senha
        function showResetPasswordForm() {
            const modal = document.createElement('div');
            modal.id = 'resetPasswordModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 40px; max-width: 450px; width: 90%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #e50914; font-size: 1.5rem; margin-bottom: 10px;">Redefinir Senha</h2>
                        <p style="color: #999; font-size: 0.9rem;">Digite sua nova senha</p>
                    </div>
                    <div id="resetPasswordAlert" class="alert"></div>
                    <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                        <div class="form-group">
                            <label>Nova Senha</label>
                            <input type="password" id="newPassword" required placeholder="M√≠nimo 6 caracteres" minlength="6" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label>Confirmar Nova Senha</label>
                            <input type="password" id="confirmPassword" required placeholder="Digite a senha novamente" minlength="6" autocomplete="new-password">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn" style="flex: 1;">Redefinir Senha</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('resetPasswordModal').remove(); window.location.href='barberflix-barbeiro.html';" style="flex: 1;">Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Fun√ß√£o para processar redefini√ß√£o de senha
        async function handleResetPassword(e) {
            e.preventDefault();
            const alert = document.getElementById('resetPasswordAlert');
            const btn = e.target.querySelector('button[type="submit"]');
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Redefinindo...';
                
                if (!newPassword || newPassword.length < 6) {
                    throw new Error('A senha deve ter no m√≠nimo 6 caracteres');
                }
                
                if (newPassword !== confirmPassword) {
                    throw new Error('As senhas n√£o coincidem');
                }
                
                showAlert(alert, 'Atualizando senha...', 'success');
                
                // Atualizar senha no Supabase Auth
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    throw new Error('Erro ao redefinir senha: ' + error.message);
                }
                
                showAlert(alert, '‚úÖ Senha redefinida com sucesso! Redirecionando para o login...', 'success');
                
                // Fechar modal e redirecionar ap√≥s 2 segundos
                setTimeout(() => {
                    const modal = document.getElementById('resetPasswordModal');
                    if (modal) modal.remove();
                    window.location.href = 'barberflix-barbeiro.html';
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao redefinir senha:', error);
                showAlert(alert, '‚ùå ' + (error.message || 'Erro ao redefinir senha'), 'error');
                btn.disabled = false;
                btn.textContent = 'Redefinir Senha';
            }
        }
        
        // ========================================
        // SISTEMA DE POLLING PARA ATUALIZA√á√ÉO AUTOM√ÅTICA
        // ========================================
        let pollingInterval = null;
        const POLLING_INTERVAL = 30000; // 30 segundos
        
        function startPolling() {
            // Limpar intervalo anterior se existir
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Iniciar polling
            pollingInterval = setInterval(() => {
                // S√≥ atualizar se estiver nas abas relevantes
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    if (tabId === 'dashboard') {
                        console.log('üîÑ Polling: Atualizando dashboard...');
                        loadBarberDashboard();
                    } else if (tabId === 'appointments') {
                        console.log('üîÑ Polling: Atualizando agendamentos...');
                        loadAppointments();
                    }
                }
            }, POLLING_INTERVAL);
            
            console.log('‚úÖ Polling iniciado (atualiza√ß√£o a cada 30s)');
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('üõë Polling parado');
            }
        }
        
        // Listener para mudan√ßas de autentica√ß√£o
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('üîê Auth state changed:', event, session?.user?.id);
            
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                window.currentUser = null;
                cleanupRealtimeSubscriptions();
                stopPolling();
                showLoginScreen();
            } else if (event === 'SIGNED_IN' && session) {
                // Sess√£o foi restaurada ou criada
                currentUser = session.user;
                window.currentUser = session.user;
                startPolling();
            } else if (event === 'TOKEN_REFRESHED' && session) {
                // Token foi renovado
                currentUser = session.user;
                window.currentUser = session.user;
            }
        });
        
        // Listener para redimensionamento da janela (fechar menu mobile se tela ficar grande)
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar) sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
        
        // Prevenir zoom em inputs no iOS
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type !== 'file') {
                    input.style.fontSize = '16px'; // Previne zoom no iOS
                }
            });
        });
        
        // Sempre iniciar verificando reset de senha primeiro
        window.addEventListener('DOMContentLoaded', async () => {
            // Verificar se h√° reset de senha na URL
            const hasReset = await checkPasswordReset();
            
            // Se n√£o houver reset, verificar autentica√ß√£o
            if (!hasReset) {
                checkAuth();
            }
        });
    </script>
</body>
</html>

