<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Barbeiro - Barberflix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #fff; overflow-x: hidden; }
        
        /* Layout Principal - Sidebar + Content */
        .main-layout { display: flex; min-height: 100vh; }
        
        /* Sidebar Lateral */
        .sidebar { width: 250px; background: #161b22; border-right: 1px solid rgba(255,255,255,0.1); position: fixed; height: 100vh; left: 0; top: 0; z-index: 1000; overflow-y: auto; }
        .sidebar-logo { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
        .sidebar-logo img { height: 80px; width: auto; }
        .sidebar-logo-text { display: none; }
        .sidebar-nav { padding: 10px 0; }
        .sidebar-nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #8b949e; cursor: pointer; transition: all 0.3s; border-left: 3px solid transparent; font-size: 14px; }
        .sidebar-nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar-nav-item.active { background: rgba(229, 9, 20, 0.15); color: #e50914; border-left-color: #e50914; }
        .sidebar-nav-item-icon { font-size: 18px; width: 24px; text-align: center; }
        
        /* Header Superior */
        .header { background: #161b22; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; width: 100%; box-sizing: border-box; }
        .header-title { font-size: 18px; font-weight: 600; color: #fff; margin: 0; }
        .header-user { display: flex; align-items: center; gap: 15px; }
        .header-user-info { display: flex; flex-direction: column; align-items: flex-end; }
        .header-user-name { font-size: 14px; color: #fff; font-weight: 500; margin: 0; }
        .header-user-email { font-size: 12px; color: #8b949e; margin: 0; }
        .header-user-avatar { width: 35px; height: 35px; border-radius: 50%; background: #e50914; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; flex-shrink: 0; }
        .header-logout { padding: 6px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #8b949e; cursor: pointer; font-size: 13px; transition: all 0.3s; font-family: inherit; }
        .header-logout:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.3); }
        .header-logout:active { transform: scale(0.98); }
        
        /* Content Area */
        .content-area { margin-left: 250px; flex: 1; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        /* Nav Tabs (removido - agora √© sidebar) */
        .nav-tabs { display: none; }
        .nav-tab { display: none; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-container { background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #ccc; font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #e50914; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 10px 20px; background: #e50914; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .btn:hover { background: #f40612; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(229, 9, 20, 0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3); }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; }
        .alert.show { display: block; }
        .alert-success { background: rgba(0,255,0,0.1); border: 1px solid rgba(0,255,0,0.3); color: #0f0; }
        .alert-error { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #f00; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .table th { color: #e50914; font-weight: 600; }
        .table tr:hover { background: rgba(255,255,255,0.05); }
        h2 { margin-bottom: 20px; font-size: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 20px; transition: all 0.3s; }
        .stat-card:hover { border-color: rgba(229, 9, 20, 0.3); transform: translateY(-2px); }
        .stat-value { font-size: 2rem; font-weight: bold; color: #e50914; margin-bottom: 5px; }
        .stat-label { color: #8b949e; font-size: 0.9rem; }
        @media (max-width: 768px) { 
            .sidebar { width: 70px; }
            .sidebar-logo-text { display: none; }
            .sidebar-nav-item-text { display: none; }
            .header { margin-left: 70px; padding: 15px 20px; }
            .content-area { margin-left: 70px; }
            .form-row { grid-template-columns: 1fr; } 
            .container { padding: 20px 15px; }
            .form-container { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .table { font-size: 0.85rem; }
            .table th, .table td { padding: 8px; }
            h2 { font-size: 1.5rem; }
            #loginContainer > div { padding: 30px 20px; width: 95%; }
        }
        @media (max-width: 480px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .header { margin-left: 0; padding: 12px 15px; }
            .content-area { margin-left: 0; }
            .container { padding: 15px 10px; }
            .form-container { padding: 15px; }
            .form-group input, .form-group textarea { font-size: 16px; padding: 14px; }
            .btn { padding: 10px 20px; font-size: 14px; }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 6px 4px; }
            #loginContainer > div { padding: 25px 15px; }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar Lateral -->
        <div class="sidebar">
            <div class="sidebar-logo" onclick="window.location.href='barberflix-cliente.html'" style="cursor: pointer;">
                <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                     alt="Barberflix Logo">
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-item active" onclick="showTab('dashboard')">
                    <span class="sidebar-nav-item-icon">üìä</span>
                    <span class="sidebar-nav-item-text">Dashboard</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('appointments')">
                    <span class="sidebar-nav-item-icon">üìÖ</span>
                    <span class="sidebar-nav-item-text">Agendamentos</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('clients')">
                    <span class="sidebar-nav-item-icon">üë•</span>
                    <span class="sidebar-nav-item-text">Clientes</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('services')">
                    <span class="sidebar-nav-item-icon">‚úÇÔ∏è</span>
                    <span class="sidebar-nav-item-text">Produtos</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('financial')">
                    <span class="sidebar-nav-item-icon">üí∞</span>
                    <span class="sidebar-nav-item-text">Financeiro</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('employees')">
                    <span class="sidebar-nav-item-icon">üë®‚Äçüíº</span>
                    <span class="sidebar-nav-item-text">Funcion√°rios</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('expenses')">
                    <span class="sidebar-nav-item-icon">üí∏</span>
                    <span class="sidebar-nav-item-text">Despesas</span>
                </div>
                <div class="sidebar-nav-item" onclick="showTab('register')">
                    <span class="sidebar-nav-item-icon">üè™</span>
                    <span class="sidebar-nav-item-text">Minha Barbearia</span>
                </div>
            </nav>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Header Superior -->
    <header class="header">
                <div class="header-title" id="pageTitle">Dashboard</div>
                <div class="header-user">
                    <div class="header-user-info">
                        <div class="header-user-name" id="userName">Carregando...</div>
                        <div class="header-user-email" id="userEmail"></div>
                    </div>
                    <div class="header-user-avatar" id="userAvatar">C</div>
                    <button class="header-logout" type="button" onclick="logout()">Sair</button>
                </div>
    </header>
    
            <!-- Container Principal -->
    <div class="container">
        <div id="dashboard" class="tab-content active">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Dashboard</h2>
                <p style="color: #999; font-size: 0.9rem;">Vis√£o geral do seu neg√≥cio</p>
            </div>
            
            <!-- Cards de M√©tricas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statToday">0</div>
                    <div class="stat-label">Agendamentos Hoje</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">üìÖ</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statPending">0</div>
                            <div class="stat-label">Agendamentos Pendentes</div>
                </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">‚è≥</div>
            </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statRevenue">R$ 0,00</div>
                            <div class="stat-label">Faturamento do M√™s</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">üí∞</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="stat-value" id="statConfirmed">0</div>
                            <div class="stat-label">Agendamentos Confirmados</div>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.3;">‚úÖ</div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√µes de Informa√ß√£o -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <!-- Pr√≥ximos Agendamentos -->
                <div class="form-container">
                    <h3 style="margin-bottom: 15px; color: #e50914;">Pr√≥ximos Agendamentos (3 horas)</h3>
                    <div id="upcomingAppointments" style="min-height: 200px;">
                        <p style="color: #999; text-align: center; padding: 20px;">Carregando...</p>
                    </div>
                </div>

                <!-- Agendamentos que Precisam de Aten√ß√£o -->
                <div class="form-container">
                    <h3 style="margin-bottom: 15px; color: #e50914;">‚ö†Ô∏è Agendamentos Pendentes</h3>
                    <div id="pendingAppointments" style="min-height: 200px;">
                        <p style="color: #999; text-align: center; padding: 20px;">Carregando...</p>
                    </div>
                </div>
            </div>

            <div id="barberShopInfo" class="form-container" style="margin-top: 20px; display: none;"></div>
        </div>

        <!-- NOVA ABA: AGENDAMENTOS -->
        <div id="appointments" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Agendamentos</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie todos os agendamentos da sua barbearia</p>
            </div>

            <!-- Filtros -->
            <div class="form-container" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filterStatus" onchange="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="all">Todos</option>
                            <option value="pending">Pendentes</option>
                            <option value="confirmed">Confirmados</option>
                            <option value="rejected">Recusados</option>
                            <option value="completed">Conclu√≠dos</option>
                            <option value="cancelled">Cancelados</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Data</label>
                        <select id="filterDate" onchange="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month">Este M√™s</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Buscar Cliente</label>
                        <input type="text" id="searchClient" placeholder="Nome ou email..." onkeyup="loadAppointments()" style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                    </div>
                </div>
            </div>

            <!-- Lista de Agendamentos -->
            <div id="appointmentsList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Carregando agendamentos...</p>
            </div>
        </div>

        <!-- NOVA ABA: CLIENTES -->
        <div id="clients" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Clientes</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie seus clientes</p>
            </div>
            <div id="clientsList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <div id="services" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Produtos/Servi√ßos</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie os servi√ßos oferecidos pela sua barbearia</p>
            </div>
            <div class="form-container">
                <div id="serviceAlert" class="alert"></div>
                <form id="serviceForm" onsubmit="handleAddService(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" id="serviceName" required>
                        </div>
                        <div class="form-group">
                            <label>Pre√ßo *</label>
                            <input type="number" id="servicePrice" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Dura√ß√£o (minutos) *</label>
                        <input type="number" id="serviceDuration" required>
                    </div>
                    <button type="submit" class="btn">Adicionar</button>
                </form>
            </div>
            <div id="servicesList" class="form-container"></div>
        </div>

        <!-- NOVA ABA: FINANCEIRO -->
        <div id="financial" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Financeiro</h2>
                <p style="color: #999; font-size: 0.9rem;">Acompanhe receitas e despesas</p>
            </div>
            <div id="financialContent" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <!-- NOVA ABA: FUNCION√ÅRIOS -->
        <div id="employees" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Funcion√°rios</h2>
                <p style="color: #999; font-size: 0.9rem;">Gerencie sua equipe</p>
            </div>
            <div id="employeesList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <!-- NOVA ABA: DESPESAS -->
        <div id="expenses" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Despesas</h2>
                <p style="color: #999; font-size: 0.9rem;">Controle seus gastos</p>
            </div>
            <div id="expensesList" class="form-container">
                <p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>
            </div>
        </div>

        <div id="register" class="tab-content">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #e50914; margin-bottom: 5px;">Minha Barbearia</h2>
                <p style="color: #999; font-size: 0.9rem;">Configure as informa√ß√µes da sua barbearia</p>
            </div>
            <div class="form-container">
                <div id="registerAlert" class="alert"></div>
                <form id="registerShopForm" onsubmit="handleRegisterShop(event)">
                    <div class="form-group">
                        <label>Nome da Barbearia *</label>
                        <input type="text" id="shopName" required>
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <textarea id="shopDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo *</label>
                        <input type="text" id="shopAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Bairro *</label>
                        <input type="text" id="shopNeighborhood" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cidade *</label>
                            <input type="text" id="shopCity" required>
                        </div>
                        <div class="form-group">
                            <label>Estado *</label>
                            <input type="text" id="shopState" required maxlength="2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CEP *</label>
                        <input type="text" id="shopZip" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="shopPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="shopEmail">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Foto de Capa</label>
                        <input type="file" id="coverImage" accept="image/*" onchange="previewImage(this, 'coverPreview')">
                        <img id="coverPreview" style="display: none; max-width: 100%; margin-top: 10px; border-radius: 5px; max-height: 200px;">
                    </div>
                    <div class="form-group">
                        <label>Foto de Perfil</label>
                        <input type="file" id="profileImage" accept="image/*" onchange="previewImage(this, 'profilePreview')">
                        <img id="profilePreview" style="display: none; max-width: 100%; margin-top: 10px; border-radius: 50%; max-height: 150px; width: 150px; object-fit: cover;">
                    </div>
                    
                    <hr style="border: 1px solid rgba(255,255,255,0.1); margin: 30px 0;">
                    <h3 style="margin-bottom: 20px; color: #e50914;">‚è∞ Hor√°rios de Funcionamento</h3>
                    <p style="color: #999; font-size: 0.9rem; margin-bottom: 20px;">Configure os hor√°rios em que sua barbearia est√° aberta. Os clientes s√≥ poder√£o agendar nestes hor√°rios.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hor√°rio de Abertura *</label>
                            <input type="time" id="shopOpenTime" required value="08:00">
                            <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Ex: 08:00</small>
                        </div>
                        <div class="form-group">
                            <label>Hor√°rio de Fechamento *</label>
                            <input type="time" id="shopCloseTime" required value="19:00">
                            <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Ex: 19:00</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Intervalo entre Agendamentos *</label>
                        <select id="shopInterval" required style="width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; font-size: 16px;">
                            <option value="15">15 minutos</option>
                            <option value="30" selected>30 minutos</option>
                            <option value="45">45 minutos</option>
                            <option value="60">1 hora</option>
                        </select>
                        <small style="color: #999; font-size: 0.85rem; margin-top: 5px; display: block;">Tempo m√≠nimo entre cada agendamento</small>
                    </div>
                    
                    <button type="submit" class="btn">Salvar</button>
                </form>
            </div>
        </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://tvvqwlxmpmolnyavabqq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dnF3bHhtcG1vbG55YXZhYnFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwODg5MjMsImV4cCI6MjA3ODY2NDkyM30.5FW2R9rcYXpAvpAjWnviBRIjeQOVf2pZwWrYrqljdHw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        
        async function checkAuth() {
            try {
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user || !user.id) {
                    console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado');
                    showLoginScreen();
                    return;
                }
                
                console.log('üîç Verificando permiss√µes para usu√°rio:', user.id);
                
                // VERIFICAR SE √â BARBEIRO
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('user_type, email, full_name')
                    .eq('id', user.id)
                    .maybeSingle();
                
                if (profileError || !profile) {
                    console.warn('‚ö†Ô∏è Perfil n√£o encontrado');
                    await supabase.auth.signOut();
                    showLoginScreen();
                    return;
                }
                
                if (profile.user_type !== 'barber') {
                    console.warn('‚ö†Ô∏è Usu√°rio n√£o √© barbeiro. Tipo:', profile.user_type);
                    await supabase.auth.signOut();
                    showLoginScreen();
                    return;
                }
                
                // VERIFICAR SE TEM BARBEARIA CADASTRADA
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', user.id)
                    .maybeSingle();
                
                if (shopError || !shop || !shop.id) {
                    console.warn('‚ö†Ô∏è Barbearia n√£o encontrada para este barbeiro');
                    await supabase.auth.signOut();
                    showLoginScreen();
                    return;
                }
                
                // SE CHEGOU AQUI, √â BARBEIRO E TEM BARBEARIA
                currentUser = user;
                window.currentUser = user;
                
                console.log('‚úÖ Usu√°rio autorizado - Barbeiro:', profile.full_name || profile.email);
                console.log('‚úÖ Barbearia:', shop.name);
                
                // Atualizar info do usu√°rio no header
                if (profile.full_name) {
                    document.getElementById('userName').textContent = profile.full_name;
                    document.getElementById('userAvatar').textContent = profile.full_name.charAt(0).toUpperCase();
                } else if (user && user.email) {
                    const emailParts = user.email.split('@');
                    document.getElementById('userName').textContent = emailParts[0] || 'Usu√°rio';
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userAvatar').textContent = emailParts[0].charAt(0).toUpperCase() || 'U';
                }
                
                // Mostrar dashboard
                hideLoginScreen();
                
            } catch (error) {
                console.error('‚ùå Erro em checkAuth:', error);
                showLoginScreen();
            }
        }
        
        function showLoginScreen() {
            // Esconder todo o conte√∫do do painel
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.style.display = 'none';
            
            // Criar tela de login
            const loginContainer = document.createElement('div');
            loginContainer.id = 'loginContainer';
            loginContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            loginContainer.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 40px; max-width: 450px; width: 90%;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="https://tvvqwlxmpmolnyavabqq.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(36)%20(1).png" 
                             alt="Barberflix Logo" 
                             style="height: 80px; margin-bottom: 15px;">
                        <h1 style="color: #e50914; font-size: 2rem; margin-bottom: 10px;">Barberflix</h1>
                        <p style="color: #999;">Painel do Barbeiro</p>
                    </div>
                    <div id="loginAlert" class="alert"></div>
                    <form id="loginForm" onsubmit="handleBarberLogin(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="barberEmail" required placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="barberPassword" required placeholder="Sua senha">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
                            <input type="checkbox" id="rememberBarber" style="width: auto;">
                            <label for="rememberBarber" style="margin: 0; color: #999; font-size: 0.9rem;">Manter logado</label>
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Entrar</button>
                    </form>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="barberflix-cliente.html" style="color: #999; text-decoration: none; font-size: 0.9rem;">Voltar para p√°gina inicial</a>
                    </div>
                </div>
            `;
            document.body.appendChild(loginContainer);
        }
        
        function hideLoginScreen() {
            const loginContainer = document.getElementById('loginContainer');
            if (loginContainer) {
                loginContainer.remove();
            }
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.style.display = 'flex';
        }
        
        async function handleBarberLogin(e) {
            e.preventDefault();
            const alert = document.getElementById('loginAlert');
            const btn = e.target.querySelector('button[type="submit"]');
            
            try {
                btn.disabled = true;
                btn.textContent = 'Entrando...';
                
                const email = document.getElementById('barberEmail').value.trim();
                const password = document.getElementById('barberPassword').value;
                const rememberMe = document.getElementById('rememberBarber').checked;
                
                if (!email || !password) {
                    throw new Error('Preencha email e senha');
                }
                
                // Limpar alerta anterior
                showAlert(alert, 'Verificando credenciais...', 'success');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    console.error('Erro de autentica√ß√£o:', error);
                    if (error.message.includes('Invalid login credentials') || error.message.includes('invalid')) {
                        throw new Error('Email ou senha incorretos. Verifique suas credenciais.');
                    }
                    throw error;
                }
                
                if (!data || !data.user) {
                    throw new Error('Erro ao fazer login. Tente novamente.');
                }
                
                // VERIFICAR SE √â BARBEIRO ANTES DE PERMITIR LOGIN
                showAlert(alert, 'Verificando permiss√µes...', 'success');
                
                // Buscar perfil do usu√°rio
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('user_type, email, full_name')
                    .eq('id', data.user.id)
                    .maybeSingle();
                
                if (profileError) {
                    throw new Error('Erro ao verificar perfil: ' + profileError.message);
                }
                
                if (!profile) {
                    await supabase.auth.signOut();
                    throw new Error('Perfil n√£o encontrado. Voc√™ precisa ser cadastrado como barbeiro pelo administrador.');
                }
                
                // VERIFICAR SE √â BARBEIRO
                if (profile.user_type !== 'barber') {
                    await supabase.auth.signOut();
                    throw new Error('Acesso negado. Apenas barbeiros podem acessar este painel. Seu tipo de usu√°rio: ' + (profile.user_type || 'n√£o definido'));
                }
                
                // VERIFICAR SE TEM BARBEARIA CADASTRADA
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', data.user.id)
                    .maybeSingle();
                
                if (shopError && !shopError.message.includes('No rows')) {
                    throw new Error('Erro ao verificar barbearia: ' + shopError.message);
                }
                
                if (!shop || !shop.id) {
                    await supabase.auth.signOut();
                    throw new Error('Voc√™ n√£o possui uma barbearia cadastrada. Entre em contato com o administrador para cadastrar sua barbearia.');
                }
                
                // SE CHEGOU AQUI, √â BARBEIRO E TEM BARBEARIA
                currentUser = data.user;
                window.currentUser = data.user;
                
                console.log('‚úÖ Login autorizado - Barbeiro:', profile.full_name || profile.email);
                console.log('‚úÖ Barbearia:', shop.name);
                
                showAlert(alert, 'Login realizado com sucesso!', 'success');
                
                // Atualizar info do usu√°rio no header
                if (profile.full_name) {
                    document.getElementById('userName').textContent = profile.full_name;
                    document.getElementById('userAvatar').textContent = profile.full_name.charAt(0).toUpperCase();
                } else if (data.user && data.user.email) {
                    const emailParts = data.user.email.split('@');
                    document.getElementById('userName').textContent = emailParts[0] || 'Usu√°rio';
                    document.getElementById('userEmail').textContent = data.user.email;
                    document.getElementById('userAvatar').textContent = emailParts[0].charAt(0).toUpperCase() || 'U';
                }
                
                // Mostrar dashboard
                hideLoginScreen();
                setTimeout(() => {
                    loadBarberDashboard();
                }, 500);
                
            } catch (error) {
                console.error('Erro no login:', error);
                showAlert(alert, error.message || 'Erro ao fazer login. Verifique suas credenciais.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        }
        
        async function showTab(tabName) {
            // Atualizar t√≠tulo da p√°gina
            const titles = {
                dashboard: 'Dashboard',
                appointments: 'Agendamentos',
                clients: 'Clientes',
                services: 'Produtos',
                financial: 'Financeiro',
                employees: 'Funcion√°rios',
                expenses: 'Despesas',
                register: 'Minha Barbearia'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';
            
            // Atualizar tabs e sidebar
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Ativar item da sidebar correspondente
            const sidebarItems = document.querySelectorAll('.sidebar-nav-item');
            sidebarItems.forEach((item, index) => {
                const tabs = ['dashboard', 'appointments', 'clients', 'services', 'financial', 'employees', 'expenses', 'register'];
                if (tabs[index] === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Garantir que currentUser est√° atualizado antes de carregar
            if (!currentUser || !currentUser.id) {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user && user.id) {
                        currentUser = user;
                        console.log('‚úÖ currentUser atualizado no showTab:', currentUser.id);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar currentUser:', error);
                }
            }
            
            if (tabName === 'dashboard') loadBarberDashboard();
            if (tabName === 'appointments') loadAppointments();
            if (tabName === 'clients') loadClients();
            if (tabName === 'services') loadServices();
            if (tabName === 'financial') loadFinancial();
            if (tabName === 'employees') loadEmployees();
            if (tabName === 'expenses') loadExpenses();
            if (tabName === 'register') loadBarberShopForm();
        }
        
        async function loadBarberDashboard() {
            // Mostrar loading
            document.querySelectorAll('.metric-card').forEach(card => {
                const content = card.querySelector('.metric-value') || card.querySelector('div');
                if (content) content.textContent = 'Carregando...';
            });
            
            try {
                // ========================================
                // BARBEREIRAS = SUPABASE (tabela barbershops)
                // ========================================
                // PRIMEIRO: Buscar informa√ß√µes da barbearia do SUPABASE
                if (!currentUser || !currentUser.id) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                console.log('üìä Buscando barbearia do Supabase (tabela barbershops) para usu√°rio:', currentUser.id);
                
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('*')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shopError) {
                    console.error('‚ùå Erro ao buscar barbearia do Supabase:', shopError);
                    throw new Error('Erro ao buscar informa√ß√µes da barbearia. Verifique sua conex√£o.');
                }
                
                if (!shop || !shop.id) {
                    document.getElementById('barberShopInfo').innerHTML = '<p style="color: #f00; padding: 20px;">‚ö†Ô∏è Cadastre sua barbearia primeiro! <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Ir para cadastro</a></p>';
                    document.getElementById('barberShopInfo').style.display = 'block';
                    throw new Error('Barbearia n√£o cadastrada');
                }
                
                console.log('‚úÖ Barbearia encontrada no Supabase:', shop.name);

                // ========================================
                // AGENDAMENTOS = PLANILHA GOOGLE SHEETS
                // ========================================
                // SEGUNDO: Buscar agendamentos da PLANILHA GOOGLE SHEETS
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                // Buscar colunas A at√© H (incluindo ID na coluna H)
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                let response;
                let data;
                let rows = [];
                
                try {
                    const fetchPromise = fetch(sheetsUrl);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout ao buscar planilha')), 10000)
                    );
                    
                    response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                    data = await response.json();
                    rows = data.values || [];
                    console.log(`‚úÖ ${rows.length} linhas encontradas na planilha`);
                } catch (fetchError) {
                    console.error('‚ùå Erro ao buscar planilha:', fetchError);
                    rows = []; // Continuar mesmo sem dados da planilha
                }
                
                // Converter para objetos
                let allAppointments = rows.map((row, index) => {
                    // Formato: Data | Hora | Cliente | Barbearia | Servi√ßos | Observa√ß√µes | Status | ID
                    // Verificar se status est√° em G ou se Observa√ß√µes cont√©m status
                    let status = row[6] || 'Pendente';
                    let appointmentId = (row[7] && String(row[7]).trim() !== '') ? String(row[7]).trim() : null; // Coluna H (ID √∫nico)
                    
                    // Log para debug
                    if (!appointmentId && index < 5) { // Log apenas primeiros 5 para n√£o poluir
                        console.log(`‚ö†Ô∏è Linha ${index + 2} sem ID - ser√° usado fallback (data+hora+email)`);
                    }
                    
                    if (!row[6] && row[5]) {
                        // Se n√£o tem status em G, verificar Observa√ß√µes
                        const notes = row[5].toLowerCase();
                        if (notes.includes('pendente')) status = 'Pendente';
                        else if (notes.includes('confirmado')) status = 'Confirmado';
                        else if (notes.includes('recusado') || notes.includes('rejeitado')) status = 'Recusado';
                        else if (notes.includes('conclu√≠do') || notes.includes('concluido')) status = 'Conclu√≠do';
                        else if (notes.includes('cancelado')) status = 'Cancelado';
                    }
                    
                    return {
                        id: `sheet_${index + 2}`, // +2 porque linha real na planilha come√ßa em 2
                        appointment_id: appointmentId, // ID √∫nico da coluna H
                        appointment_date: row[0] || '',
                        appointment_time: row[1] || '',
                        client_email: row[2] || '',
                        barbershop_name: row[3] || '',
                        services: row[4] || '',
                        notes: row[5] || '',
                        status: status.toLowerCase()
                            .replace('pendente', 'pending')
                            .replace('confirmado', 'confirmed')
                            .replace('recusado', 'rejected')
                            .replace('rejeitado', 'rejected')
                            .replace('conclu√≠do', 'completed')
                            .replace('concluido', 'completed')
                            .replace('cancelado', 'cancelled')
                            .trim() || 'pending'
                    };
                }).filter(apt => apt.appointment_date && apt.appointment_time);
                
                console.log(`üìã ${allAppointments.length} agendamentos encontrados:`, allAppointments);
                
                // Filtrar agendamentos da planilha usando nome da barbearia do Supabase
                // (Usa informa√ß√µes do Supabase para filtrar dados da planilha)
                if (!shop || !shop.name) {
                    throw new Error('Informa√ß√µes da barbearia incompletas');
                }
                
                console.log('üîç Filtrando agendamentos da planilha usando nome da barbearia do Supabase:', shop.name);
                allAppointments = allAppointments.filter(apt => {
                    if (!apt.barbershop_name) return false;
                    const aptName = apt.barbershop_name.toLowerCase().trim();
                    const shopName = shop.name.toLowerCase().trim();
                    return aptName === shopName || 
                           aptName.includes(shopName) || 
                           shopName.includes(aptName);
                });
                
                console.log(`‚úÖ ${allAppointments.length} agendamentos da planilha encontrados para barbearia "${shop.name}" do Supabase`);
                
                const today = new Date().toISOString().split('T')[0];
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                
                // Filtrar agendamentos
                const todayAppointments = allAppointments.filter(apt => apt.appointment_date === today);
                const pendingAppointments = allAppointments.filter(apt => apt.status === 'pending');
                const confirmedAppointments = allAppointments.filter(apt => apt.status === 'confirmed');
                const monthAppointments = allAppointments.filter(apt => 
                    apt.appointment_date >= startOfMonth && 
                    (apt.status === 'confirmed' || apt.status === 'completed')
                );
                
                // Calcular receita
                let revenue = 0;
                monthAppointments.forEach(apt => {
                    const services = apt.services || '';
                    const priceMatch = services.match(/R\$\s*(\d+[\.,]\d+)/);
                    if (priceMatch) {
                        revenue += parseFloat(priceMatch[1].replace(',', '.'));
                    }
                });
                
                // Atualizar estat√≠sticas
                document.getElementById('statToday').textContent = todayAppointments.length;
                document.getElementById('statPending').textContent = pendingAppointments.length;
                document.getElementById('statRevenue').textContent = `R$ ${revenue.toFixed(2).replace('.', ',')}`;
                document.getElementById('statConfirmed').textContent = confirmedAppointments.length;
                
                // Pr√≥ximos agendamentos (pr√≥ximas 3 horas)
                const now = new Date();
                const threeHoursLater = new Date(now.getTime() + 3 * 60 * 60 * 1000);
                const upcoming = todayAppointments
                    .filter(apt => {
                        const aptTime = apt.appointment_time.split(':');
                        const aptHour = parseInt(aptTime[0]);
                        const aptMin = parseInt(aptTime[1]);
                        const nowHour = now.getHours();
                        const nowMin = now.getMinutes();
                        const laterHour = threeHoursLater.getHours();
                        const laterMin = threeHoursLater.getMinutes();
                        
                        const aptTotal = aptHour * 60 + aptMin;
                        const nowTotal = nowHour * 60 + nowMin;
                        const laterTotal = laterHour * 60 + laterMin;
                        
                        return aptTotal >= nowTotal && aptTotal <= laterTotal && 
                               (apt.status === 'confirmed' || apt.status === 'pending');
                    })
                    .sort((a, b) => a.appointment_time.localeCompare(b.appointment_time))
                    .slice(0, 5);
                
                if (upcoming.length > 0) {
                    document.getElementById('upcomingAppointments').innerHTML = upcoming.map(apt => `
                        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${apt.client_email || 'Cliente'}</div>
                                <div style="color: #999; font-size: 0.9rem;">‚è∞ ${apt.appointment_time}</div>
                            </div>
                            <span style="padding: 5px 10px; background: ${apt.status === 'confirmed' ? 'rgba(0,255,0,0.2)' : 'rgba(255,152,0,0.2)'}; border-radius: 5px; font-size: 0.85rem;">
                                ${apt.status === 'confirmed' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                            </span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('upcomingAppointments').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum agendamento nas pr√≥ximas 3 horas</p>';
                }
                
                // Agendamentos pendentes (top 5)
                if (pendingAppointments.length > 0) {
                    const topPending = pendingAppointments.slice(0, 5);
                    document.getElementById('pendingAppointments').innerHTML = topPending.map(apt => `
                        <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-weight: 600; margin-bottom: 5px;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</div>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üë§ ${apt.client_email || 'Cliente'}</div>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 10px;">${apt.notes || 'Sem observa√ß√µes'}</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="acceptAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')">‚úÖ Aceitar</button>
                                <button class="btn btn-danger" style="width: 100%; padding: 8px; font-size: 0.9rem;" onclick="rejectAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')">‚ùå Recusar</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('pendingAppointments').innerHTML = '<p style="color: #0f0; text-align: center; padding: 20px;">‚úÖ Nenhum agendamento pendente</p>';
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                // Mostrar mensagem de erro
                document.querySelectorAll('.metric-card').forEach(card => {
                    const content = card.querySelector('.metric-value') || card.querySelector('div');
                    if (content) content.textContent = 'Erro';
                });
            }
        }
        
        // FUN√á√ÉO PARA CARREGAR AGENDAMENTOS DA PLANILHA GOOGLE SHEETS
        async function loadAppointments() {
            // Mostrar loading
            const listEl = document.getElementById('appointmentsList');
            if (!listEl) {
                console.error('‚ùå Elemento appointmentsList n√£o encontrado');
                return;
            }
            
            listEl.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Carregando agendamentos...</p>';
            
            try {
                // ========================================
                // BARBEREIRAS = SUPABASE (tabela barbershops)
                // ========================================
                // PRIMEIRO: Buscar informa√ß√µes da barbearia do SUPABASE
                if (!currentUser || !currentUser.id) {
                    listEl.innerHTML = '<p style="color: #f00;">Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                console.log('üìä Buscando barbearia do Supabase (tabela barbershops) para usu√°rio:', currentUser.id);
                
                const { data: shop, error: shopError } = await supabase
                    .from('barbershops')
                    .select('id, name')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shopError) {
                    console.error('‚ùå Erro ao buscar barbearia do Supabase:', shopError);
                    listEl.innerHTML = '<p style="color: #f00;">Erro ao buscar informa√ß√µes da barbearia. <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Cadastre sua barbearia</a></p>';
                    return;
                }
                
                if (!shop || !shop.id || !shop.name) {
                    listEl.innerHTML = '<p style="color: #f00;">‚ö†Ô∏è Cadastre sua barbearia primeiro! <a href="#" onclick="showTab(\'register\'); return false;" style="color: #e50914;">Ir para cadastro</a></p>';
                    return;
                }
                
                console.log('‚úÖ Barbearia encontrada no Supabase:', shop.name);
                
                // Filtros
                const statusFilter = document.getElementById('filterStatus')?.value || 'all';
                const dateFilter = document.getElementById('filterDate')?.value || 'all';
                const searchTerm = (document.getElementById('searchClient')?.value || '').toLowerCase();
                
                // ========================================
                // AGENDAMENTOS = PLANILHA GOOGLE SHEETS
                // ========================================
                // SEGUNDO: Buscar agendamentos da PLANILHA GOOGLE SHEETS
                const SPREADSHEET_ID = '1YKXLl1zuKxLhyFLsZDWN2MKbUgGU-idOlT0ZBv_z2lQ';
                const API_KEY = 'AIzaSyBI140KHzvGa6B7vcrXHzKpSysPEkt4W88';
                
                // Ler dados da planilha (colunas A at√© H - incluindo ID √∫nico)
                const sheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A2:H1000?key=${API_KEY}`;
                
                console.log('üìä Buscando agendamentos da planilha...');
                
                let response;
                let data;
                
                try {
                    const fetchPromise = fetch(sheetsUrl);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout ao buscar planilha')), 10000)
                    );
                    
                    response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    
                    data = await response.json();
                } catch (fetchError) {
                    console.error('‚ùå Erro ao buscar planilha:', fetchError);
                    document.getElementById('appointmentsList').innerHTML = '<p style="color: #f00;">Erro ao carregar agendamentos. Verifique sua conex√£o e tente novamente.</p>';
                    return;
                }
                
                const rows = data.values || [];
                console.log(`‚úÖ ${rows.length} linhas encontradas na planilha`);
                
                // Converter linhas da planilha em objetos de agendamento
                let appointments = rows.map((row, index) => {
                    // Formato: Data | Hora | Cliente | Barbearia | Servi√ßos | Observa√ß√µes | Status | ID
                    // Na planilha, √†s vezes Status est√° vazio em G e aparece em F (Observa√ß√µes)
                    let status = row[6] || 'Pendente'; // Coluna G primeiro
                    let notes = row[5] || ''; // Coluna F
                    let appointmentId = (row[7] && String(row[7]).trim() !== '') ? String(row[7]).trim() : null; // Coluna H (ID √∫nico)
                    
                    // Log para debug
                    if (!appointmentId) {
                        console.log(`‚ö†Ô∏è Linha ${index + 2} sem ID - ser√° usado fallback (data+hora+email)`);
                    }
                    
                    // Se n√£o tem status em G, verificar se Observa√ß√µes cont√©m status
                    if (!row[6] || row[6].trim() === '') {
                        const notesLower = (notes || '').toLowerCase();
                        if (notesLower === 'pendente' || notesLower.includes('pendente') && !notesLower.includes('servi√ßos')) {
                            status = 'Pendente';
                            notes = ''; // Limpar notes se era s√≥ o status
                        } else if (notesLower.includes('confirmado')) {
                            status = 'Confirmado';
                            notes = notes.replace(/confirmado/gi, '').trim();
                        } else if (notesLower.includes('recusado') || notesLower.includes('rejeitado')) {
                            status = 'Recusado';
                        } else if (notesLower.includes('conclu√≠do') || notesLower.includes('concluido')) {
                            status = 'Conclu√≠do';
                        } else if (notesLower.includes('cancelado')) {
                            status = 'Cancelado';
                        } else {
                            status = 'Pendente'; // Padr√£o
                        }
                    }
                    
                    return {
                        id: `sheet_${index + 2}`, // +2 porque linha real na planilha √© A2, A3, etc
                        appointment_id: appointmentId, // ID √∫nico da coluna H
                        appointment_date: row[0] || '',
                        appointment_time: row[1] || '',
                        client_email: row[2] || '',
                        barbershop_name: row[3] || '',
                        services: row[4] || '',
                        notes: notes,
                        status: status.toLowerCase()
                            .replace('pendente', 'pending')
                            .replace('confirmado', 'confirmed')
                            .replace('recusado', 'rejected')
                            .replace('rejeitado', 'rejected')
                            .replace('conclu√≠do', 'completed')
                            .replace('concluido', 'completed')
                            .replace('cancelado', 'cancelled')
                            .trim() || 'pending'
                    };
                }).filter(apt => apt.appointment_date && apt.appointment_time);
                
                console.log(`üìã ${appointments.length} agendamentos processados:`, appointments);
                
                // Filtrar agendamentos da planilha usando nome da barbearia do Supabase
                // (Usa informa√ß√µes do Supabase para filtrar dados da planilha)
                if (!shop || !shop.name) {
                    listEl.innerHTML = '<p style="color: #f00;">Informa√ß√µes da barbearia incompletas</p>';
                    return;
                }
                
                console.log('üîç Filtrando agendamentos da planilha usando nome da barbearia do Supabase:', shop.name);
                appointments = appointments.filter(apt => {
                    if (!apt.barbershop_name) return false;
                    const aptName = apt.barbershop_name.toLowerCase().trim();
                    const shopName = shop.name.toLowerCase().trim();
                    return aptName === shopName || 
                           aptName.includes(shopName) || 
                           shopName.includes(aptName);
                });
                
                console.log(`‚úÖ ${appointments.length} agendamentos da planilha encontrados para barbearia "${shop.name}" do Supabase`);
                
                // Aplicar filtros
                if (statusFilter !== 'all') {
                    appointments = appointments.filter(apt => apt.status === statusFilter);
                }
                
                if (dateFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    appointments = appointments.filter(apt => apt.appointment_date === today);
                } else if (dateFilter === 'week') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    appointments = appointments.filter(apt => apt.appointment_date >= weekAgo.toISOString().split('T')[0]);
                } else if (dateFilter === 'month') {
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    appointments = appointments.filter(apt => apt.appointment_date >= monthAgo.toISOString().split('T')[0]);
                }
                
                // Filtrar por busca de cliente
                if (searchTerm) {
                    appointments = appointments.filter(apt => 
                        (apt.client_email || '').toLowerCase().includes(searchTerm)
                    );
                }
                
                if (!appointments || appointments.length === 0) {
                    document.getElementById('appointmentsList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Nenhum agendamento encontrado</p>';
                    return;
                }
                
                // Renderizar agendamentos
                document.getElementById('appointmentsList').innerHTML = appointments.map(apt => {
                    const statusColors = {
                        pending: { bg: 'rgba(255,152,0,0.2)', color: '#ff9800', text: '‚è≥ Pendente' },
                        confirmed: { bg: 'rgba(0,255,0,0.2)', color: '#0f0', text: '‚úÖ Confirmado' },
                        rejected: { bg: 'rgba(255,0,0,0.2)', color: '#f00', text: '‚ùå Recusado' },
                        completed: { bg: 'rgba(0,0,255,0.2)', color: '#00f', text: '‚úÖ Conclu√≠do' },
                        cancelled: { bg: 'rgba(128,128,128,0.2)', color: '#888', text: 'üö´ Cancelado' }
                    };
                    const status = statusColors[apt.status] || statusColors.pending;
                    
                    return `
                        <div style="background: #161b22; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">üë§ ${apt.client_email || 'Cliente'}</div>
                                    <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">üìß ${apt.client_email || 'Email n√£o dispon√≠vel'}</div>
                                    <div style="color: #999; font-size: 0.9rem;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</div>
                                    ${apt.services ? `<div style="color: #e50914; font-size: 0.9rem; margin-top: 5px;">üíá ${apt.services}</div>` : ''}
                                </div>
                                <span style="padding: 5px 15px; background: ${status.bg}; color: ${status.color}; border-radius: 5px; font-size: 0.85rem; font-weight: 600;">
                                    ${status.text}
                                </span>
                            </div>
                            
                            ${apt.notes ? `<div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin-bottom: 15px; color: #ccc;">
                                <strong>Observa√ß√µes:</strong> ${apt.notes}
                            </div>` : ''}
                            
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${apt.status === 'pending' ? `
                                    <button class="btn" onclick="acceptAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚úÖ Aceitar</button>
                                    <button class="btn btn-danger" onclick="rejectAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚ùå Recusar</button>
                                ` : ''}
                                ${apt.status === 'confirmed' ? `
                                    <button class="btn" onclick="completeAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">‚úÖ Marcar como Conclu√≠do</button>
                                    <button class="btn btn-danger" onclick="cancelAppointmentSheet('${apt.id}', '${apt.appointment_date}', '${apt.appointment_time}', '${(apt.client_email || '').replace(/'/g, "\\'")}', '${(apt.barbershop_name || '').replace(/'/g, "\\'")}', '${(apt.appointment_id || '').replace(/'/g, "\\'")}')" style="width: 100%;">üö´ Cancelar</button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="viewAppointmentDetails('${apt.id}')" style="width: 100%;">üëÅÔ∏è Ver Detalhes</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                document.getElementById('appointmentsList').innerHTML = `<p style="color: #f00;">Erro: ${error.message}</p>`;
            }
        }
        
        // FUN√á√ïES PARA ATUALIZAR STATUS NA PLANILHA
        async function acceptAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Confirmar este agendamento?')) return;
            await updateAppointmentStatusInSheet(date, time, 'Confirmado', '', clientEmail, barbershopName, appointmentId);
        }
        
        async function rejectAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            const reason = prompt('Motivo da recusa (opcional):');
            if (reason === null) return;
            await updateAppointmentStatusInSheet(date, time, 'Cancelado', reason, clientEmail, barbershopName, appointmentId);
        }
        
        async function completeAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Marcar como conclu√≠do?')) return;
            await updateAppointmentStatusInSheet(date, time, 'Conclu√≠do', '', clientEmail, barbershopName, appointmentId);
        }
        
        async function cancelAppointmentSheet(id, date, time, clientEmail = '', barbershopName = '', appointmentId = null) {
            if (!confirm('Cancelar este agendamento?')) return;
            await updateAppointmentStatusInSheet(date, time, 'Cancelado', '', clientEmail, barbershopName, appointmentId);
        }
        
        // Fun√ß√£o para atualizar status na planilha (formato correto)
        async function updateAppointmentStatusInSheet(date, time, newStatus, reason = '', clientEmail = '', barbershopName = '', appointmentId = null) {
            try {
                // Usar Google Apps Script para atualizar (mais confi√°vel)
                // ATUALIZAR ESTA URL COM A URL DO SEU WEB APP
                const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw0RdEwq2Y4rsUj3-Tz-1XQA9FOnnbVaWiYT_ddiVS9it6METaGnsgH_-Mbb_NopZvdNg/exec';
                
                // CR√çTICO: action: 'updateStatus' DEVE estar presente para atualizar linha existente
                // Sem isso, o Google Apps Script criar√° uma nova linha!
                const updateData = {
                    action: 'updateStatus', // OBRIGAT√ìRIO: Indica que √© uma atualiza√ß√£o, n√£o cria√ß√£o
                    appointment_id: appointmentId || null, // ID √∫nico (m√©todo principal - se dispon√≠vel)
                    appointment_date: date, // Data para encontrar a linha (fallback)
                    appointment_time: time, // Hora para encontrar a linha (fallback)
                    client_email: clientEmail || '', // Email para encontrar a linha (fallback)
                    barbershop_name: barbershopName || '', // Nome da barbearia (opcional)
                    status: newStatus // Novo status em portugu√™s
                };
                
                console.log('üîç Dados enviados para ATUALIZAR (n√£o criar):', updateData);
                console.log('‚ö†Ô∏è IMPORTANTE: action="updateStatus" est√° presente!');
                
                // Valida√ß√£o mais rigorosa
                if (!updateData.appointment_id && (!updateData.appointment_date || !updateData.appointment_time || !updateData.client_email)) {
                    console.error('‚ùå ERRO: Dados insuficientes para atualizar!');
                    console.error('   appointment_id:', updateData.appointment_id);
                    console.error('   appointment_date:', updateData.appointment_date);
                    console.error('   appointment_time:', updateData.appointment_time);
                    console.error('   client_email:', updateData.client_email);
                    alert('‚ùå Erro: Dados insuficientes para atualizar. Verifique o console.\n\nNecess√°rio: ID OU (Data + Hora + Email)');
                    return;
                }
                
                // Log detalhado
                if (updateData.appointment_id) {
                    console.log('‚úÖ Usando ID √∫nico:', updateData.appointment_id);
                } else {
                    console.log('‚ö†Ô∏è Usando fallback (data+hora+email):', {
                        date: updateData.appointment_date,
                        time: updateData.appointment_time,
                        email: updateData.client_email
                    });
                }
                
                console.log('üì§ Atualizando status na planilha (ATUALIZAR linha existente)...', updateData);
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                // Com no-cors n√£o conseguimos ler resposta, mas assumimos sucesso
                console.log('‚úÖ Status atualizado na planilha (linha existente)!');
                console.log('üìã ID usado:', updateData.appointment_id || 'fallback (data+hora+email)');
                
                alert(`‚úÖ Status atualizado para: ${newStatus}`);
                
                // Recarregar dados IMEDIATAMENTE para remover da lista de pendentes
                setTimeout(() => {
                    loadAppointments();
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadBarberDashboard();
                    }
                }, 500); // Aumentado para 500ms para garantir que a planilha foi atualizada
                
            } catch (error) {
                console.error('Erro ao atualizar planilha:', error);
                alert('Erro ao atualizar: ' + error.message);
            }
        }
        
        // FUN√á√ïES DE A√á√ÉO PARA AGENDAMENTOS
        async function acceptAppointment(appointmentId) {
            if (!confirm('Confirmar este agendamento?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'confirmed' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚úÖ Agendamento confirmado!');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function rejectAppointment(appointmentId) {
            const reason = prompt('Motivo da recusa (opcional):');
            if (reason === null) return; // Usu√°rio cancelou
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ 
                        status: 'rejected',
                        notes: reason ? `RECUSADO: ${reason}` : 'RECUSADO'
                    })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚ùå Agendamento recusado.');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function completeAppointment(appointmentId) {
            if (!confirm('Marcar este agendamento como conclu√≠do?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'completed' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('‚úÖ Agendamento marcado como conclu√≠do!');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function cancelAppointment(appointmentId) {
            if (!confirm('Cancelar este agendamento?')) return;
            
            try {
                const { error } = await supabase
                    .from('appointments')
                    .update({ status: 'cancelled' })
                    .eq('id', appointmentId);
                
                if (error) throw error;
                
                alert('üö´ Agendamento cancelado.');
                loadAppointments();
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadBarberDashboard();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        function viewAppointmentDetails(appointmentId) {
            alert('Detalhes do agendamento (em desenvolvimento)');
        }
        
        // FUN√á√ïES PLACEHOLDER PARA OUTRAS ABAS
        function loadClients() {
            document.getElementById('clientsList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>';
        }
        
        function loadFinancial() {
            document.getElementById('financialContent').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>';
        }
        
        function loadEmployees() {
            document.getElementById('employeesList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>';
        }
        
        function loadExpenses() {
            document.getElementById('expensesList').innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Funcionalidade em desenvolvimento...</p>';
        }
        
        async function loadServices() {
            if (!currentUser || !currentUser.id) {
                console.warn('‚ö†Ô∏è currentUser n√£o dispon√≠vel para loadServices');
                return;
            }
            try {
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) {
                    document.getElementById('servicesList').innerHTML = '<p style="color: #f00;">Cadastre sua barbearia primeiro!</p>';
                    return;
                }
                
                const { data: services } = await supabase
                    .from('services')
                    .select('*')
                    .eq('barbershop_id', shop.id)
                    .order('name');
                
                if (!services || services.length === 0) {
                    document.getElementById('servicesList').innerHTML = '<p style="color: #999;">Nenhum servi√ßo cadastrado.</p>';
                    return;
                }
                
                document.getElementById('servicesList').innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Pre√ßo</th>
                                <th>Dura√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${services.map(s => `
                                <tr>
                                    <td>${s.name}</td>
                                    <td>R$ ${parseFloat(s.price).toFixed(2)}</td>
                                    <td>${s.duration} min</td>
                                    <td><button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteService('${s.id}')">Remover</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('servicesList').innerHTML = '<p style="color: #f00;">Erro: ' + error.message + '</p>';
            }
        }
        
        async function handleAddService(e) {
            e.preventDefault();
            const alert = document.getElementById('serviceAlert');
            
            if (!currentUser || !currentUser.id) {
                showAlert(alert, 'Erro: Voc√™ precisa estar logado.', 'error');
                return;
            }
            
            try {
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (!shop) throw new Error('Cadastre sua barbearia primeiro!');
                
                const { error } = await supabase.from('services').insert({
                    barbershop_id: shop.id,
                    name: document.getElementById('serviceName').value,
                    price: parseFloat(document.getElementById('servicePrice').value),
                    duration: parseInt(document.getElementById('serviceDuration').value)
                });
                
                if (error) throw error;
                
                showAlert(alert, 'Servi√ßo adicionado!', 'success');
                document.getElementById('serviceForm').reset();
                loadServices();
            } catch (error) {
                showAlert(alert, error.message, 'error');
            }
        }
        
        async function deleteService(id) {
            if (!confirm('Remover este servi√ßo?')) return;
            try {
                const { error } = await supabase.from('services').delete().eq('id', id);
                if (error) throw error;
                loadServices();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }
        
        async function loadBarberShopForm() {
            if (!currentUser || !currentUser.id) {
                console.warn('‚ö†Ô∏è currentUser n√£o dispon√≠vel para loadBarberShopForm');
                return;
            }
            try {
                const { data: shop } = await supabase
                    .from('barbershops')
                    .select('*')
                    .eq('barber_id', currentUser.id)
                    .single();
                
                if (shop) {
                    document.getElementById('shopName').value = shop.name || '';
                    document.getElementById('shopDescription').value = shop.description || '';
                    document.getElementById('shopAddress').value = shop.address || '';
                    document.getElementById('shopNeighborhood').value = shop.neighborhood || '';
                    document.getElementById('shopCity').value = shop.city || '';
                    document.getElementById('shopState').value = shop.state || '';
                    document.getElementById('shopZip').value = shop.zip_code || '';
                    document.getElementById('shopPhone').value = shop.phone || '';
                    document.getElementById('shopEmail').value = shop.email || '';
                    
                    // Mostrar fotos se existirem
                    if (shop.cover_image) {
                        document.getElementById('coverPreview').src = shop.cover_image;
                        document.getElementById('coverPreview').style.display = 'block';
                    }
                    if (shop.profile_image) {
                        document.getElementById('profilePreview').src = shop.profile_image;
                        document.getElementById('profilePreview').style.display = 'block';
                    }
                    
                    // Carregar hor√°rios de funcionamento (se a coluna existir)
                    try {
                        if (shop.business_hours) {
                            const hours = typeof shop.business_hours === 'string' 
                                ? JSON.parse(shop.business_hours) 
                                : shop.business_hours;
                            
                            if (hours && hours.start) {
                                document.getElementById('shopOpenTime').value = hours.start;
                            }
                            if (hours && hours.end) {
                                document.getElementById('shopCloseTime').value = hours.end;
                            }
                            if (hours && hours.interval) {
                                document.getElementById('shopInterval').value = hours.interval;
                            }
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao carregar hor√°rios (coluna pode n√£o existir):', e);
                        // Usar valores padr√£o se n√£o conseguir carregar
                        document.getElementById('shopOpenTime').value = '08:00';
                        document.getElementById('shopCloseTime').value = '19:00';
                        document.getElementById('shopInterval').value = '30';
                    }
                }
            } catch (error) {
                console.error(error);
            }
        }
        
        async function handleRegisterShop(e) {
            e.preventDefault();
            const alert = document.getElementById('registerAlert');
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            // Verificar e atualizar currentUser antes de salvar
            if (!currentUser || !currentUser.id) {
                console.log('‚ö†Ô∏è currentUser n√£o definido, buscando sess√£o...');
                try {
                    const { data: { user }, error: sessionError } = await supabase.auth.getUser();
                    if (sessionError) {
                        throw sessionError;
                    }
                    if (user && user.id) {
                        currentUser = user;
                        console.log('‚úÖ currentUser atualizado:', currentUser.id);
                    } else {
                        throw new Error('Usu√°rio n√£o encontrado na sess√£o');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', error);
                    const errorMsg = 'Erro: Voc√™ precisa estar logado para salvar. Fa√ßa login novamente.';
                    if (alert) {
                        showAlert(alert, errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                    return;
                }
            }
            
            // Desabilitar bot√£o e mostrar loading
            if (submitButton) {
                submitButton.disabled = true;
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Salvando...';
                
                try {
                    await handleRegisterShopLogic(alert);
                    submitButton.textContent = originalText;
                } catch (error) {
                    submitButton.textContent = originalText;
                    throw error;
                } finally {
                    submitButton.disabled = false;
                }
            } else {
                await handleRegisterShopLogic(alert);
            }
        }
        
        async function handleRegisterShopLogic(alert) {
            console.log('=== handleRegisterShopLogic INICIADO ===');
            console.log('currentUser:', currentUser);
            console.log('alert element:', alert);
            
            if (!currentUser || !currentUser.id) {
                const errorMsg = 'Erro: Voc√™ precisa estar logado para salvar. Fa√ßa login novamente.';
                console.error('‚ùå currentUser inv√°lido:', currentUser);
                if (alert) {
                    showAlert(alert, errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            const userId = currentUser.id;
            console.log('‚úÖ Usu√°rio v√°lido, ID:', userId);
            
            try {
                // Verificar se j√° existe barbearia
                console.log('Buscando barbearia existente...');
                const { data: existingShop, error: searchError } = await supabase
                    .from('barbershops')
                    .select('id')
                    .eq('barber_id', userId)
                    .maybeSingle();
                
                if (searchError) {
                    console.error('‚ùå Erro ao buscar barbearia:', searchError);
                    throw new Error('Erro ao verificar barbearia: ' + searchError.message);
                }
                
                console.log('Barbearia existente:', existingShop);
                
                if (existingShop) {
                    console.log('üîÑ Atualizando barbearia existente...');
                    // Atualizar
                    const openTime = document.getElementById('shopOpenTime').value;
                    const closeTime = document.getElementById('shopCloseTime').value;
                    const interval = parseInt(document.getElementById('shopInterval').value);
                    
                    console.log('‚è∞ Hor√°rios configurados:', { openTime, closeTime, interval });
                    
                    const updateData = {
                        name: document.getElementById('shopName').value,
                        description: document.getElementById('shopDescription').value || null,
                        address: document.getElementById('shopAddress').value,
                        neighborhood: document.getElementById('shopNeighborhood').value,
                        city: document.getElementById('shopCity').value,
                        state: document.getElementById('shopState').value,
                        zip_code: document.getElementById('shopZip').value,
                        phone: document.getElementById('shopPhone').value || null,
                        email: document.getElementById('shopEmail').value || null,
                        is_active: true,
                        business_hours: {
                            start: openTime,
                            end: closeTime,
                            interval: interval
                        }
                    };
                    
                    console.log('üì§ Dados para atualizar:', updateData);
                    
                    // Adicionar URLs das imagens se foram atualizadas
                    const coverImage = document.getElementById('coverImage').files[0];
                    const profileImage = document.getElementById('profileImage').files[0];
                    
                    if (coverImage) {
                        console.log('üì∑ Fazendo upload da capa...');
                        const coverUrl = await uploadImage(coverImage, `barbershops/${existingShop.id}/cover`);
                        updateData.cover_image = coverUrl;
                    }
                    
                    if (profileImage) {
                        console.log('üì∑ Fazendo upload do perfil...');
                        const profileUrl = await uploadImage(profileImage, `barbershops/${existingShop.id}/profile`);
                        updateData.profile_image = profileUrl;
                    }
                    
                    console.log('üíæ Salvando no banco...');
                    let { error } = await supabase.from('barbershops').update(updateData).eq('id', existingShop.id);
                    
                    // Se der erro de coluna n√£o encontrada, tentar sem business_hours
                    if (error && (error.message.includes('business_hours') || error.message.includes('column') || error.message.includes('schema cache'))) {
                        console.warn('‚ö†Ô∏è Coluna business_hours n√£o existe, tentando salvar sem ela...');
                        const { business_hours, ...updateDataWithoutHours } = updateData;
                        const { error: retryError } = await supabase.from('barbershops').update(updateDataWithoutHours).eq('id', existingShop.id);
                        
                        if (retryError) {
                            console.error('‚ùå Erro do Supabase:', retryError);
                            throw retryError;
                        }
                        
                        // Mostrar aviso para executar SQL
                        if (alert) {
                            showAlert(alert, '‚ö†Ô∏è Barbearia atualizada, mas hor√°rios n√£o foram salvos. Execute o SQL add_business_hours_column.sql no Supabase para habilitar hor√°rios.', 'error');
                        } else {
                            alert('‚ö†Ô∏è Barbearia atualizada, mas execute o SQL add_business_hours_column.sql no Supabase.');
                        }
                        return;
                    }
                    
                    if (error) {
                        console.error('‚ùå Erro do Supabase:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Barbearia atualizada com sucesso!');
                    if (alert) {
                        showAlert(alert, '‚úÖ Barbearia atualizada com sucesso!', 'success');
                    } else {
                        alert('Barbearia atualizada com sucesso!');
                    }
                } else {
                    console.log('üÜï Criando nova barbearia...');
                    // Criar nova
                    const openTime = document.getElementById('shopOpenTime').value;
                    const closeTime = document.getElementById('shopCloseTime').value;
                    const interval = parseInt(document.getElementById('shopInterval').value);
                    
                    console.log('‚è∞ Hor√°rios configurados:', { openTime, closeTime, interval });
                    
                    if (!userId) {
                        throw new Error('ID do usu√°rio n√£o encontrado. Fa√ßa login novamente.');
                    }
                    
                    const insertData = {
                        barber_id: userId,
                        name: document.getElementById('shopName').value,
                        description: document.getElementById('shopDescription').value || null,
                        address: document.getElementById('shopAddress').value,
                        neighborhood: document.getElementById('shopNeighborhood').value,
                        city: document.getElementById('shopCity').value,
                        state: document.getElementById('shopState').value,
                        zip_code: document.getElementById('shopZip').value,
                        phone: document.getElementById('shopPhone').value || null,
                        email: document.getElementById('shopEmail').value || null,
                        is_active: true,
                        business_hours: {
                            start: openTime,
                            end: closeTime,
                            interval: interval
                        }
                    };
                    
                    console.log('üì§ Dados para inserir:', insertData);
                    console.log('üíæ Inserindo no banco...');
                    
                    let { data: newShop, error: insertError } = await supabase.from('barbershops').insert(insertData).select().single();
                    
                    // Se der erro de coluna n√£o encontrada, tentar sem business_hours
                    if (insertError && (insertError.message.includes('business_hours') || insertError.message.includes('column') || insertError.message.includes('schema cache'))) {
                        console.warn('‚ö†Ô∏è Coluna business_hours n√£o existe, tentando inserir sem ela...');
                        const { business_hours, ...insertDataWithoutHours } = insertData;
                        const { data: retryShop, error: retryError } = await supabase.from('barbershops').insert(insertDataWithoutHours).select().single();
                        
                        if (retryError) {
                            console.error('‚ùå Erro do Supabase ao inserir:', retryError);
                            throw retryError;
                        }
                        
                        newShop = retryShop;
                        
                        // Mostrar aviso para executar SQL
                        if (alert) {
                            showAlert(alert, '‚ö†Ô∏è Barbearia criada, mas hor√°rios n√£o foram salvos. Execute o SQL add_business_hours_column.sql no Supabase e atualize os hor√°rios depois.', 'error');
                        } else {
                            alert('‚ö†Ô∏è Barbearia criada, mas execute o SQL add_business_hours_column.sql no Supabase.');
                        }
                    } else if (insertError) {
                        console.error('‚ùå Erro do Supabase ao inserir:', insertError);
                        throw insertError;
                    }
                    
                    console.log('‚úÖ Barbearia criada! ID:', newShop?.id);
                    
                    // Upload de imagens se foram selecionadas
                    const coverImage = document.getElementById('coverImage').files[0];
                    const profileImage = document.getElementById('profileImage').files[0];
                    
                    if (coverImage && newShop) {
                        try {
                            console.log('üì∑ Fazendo upload da capa...');
                            const coverUrl = await uploadImage(coverImage, `barbershops/${newShop.id}/cover`);
                            await supabase.from('barbershops').update({ cover_image: coverUrl }).eq('id', newShop.id);
                            console.log('‚úÖ Capa atualizada');
                        } catch (imgError) {
                            console.error('Erro ao fazer upload da capa:', imgError);
                        }
                    }
                    
                    if (profileImage && newShop) {
                        try {
                            console.log('üì∑ Fazendo upload do perfil...');
                            const profileUrl = await uploadImage(profileImage, `barbershops/${newShop.id}/profile`);
                            await supabase.from('barbershops').update({ profile_image: profileUrl }).eq('id', newShop.id);
                            console.log('‚úÖ Perfil atualizado');
                        } catch (imgError) {
                            console.error('Erro ao fazer upload do perfil:', imgError);
                        }
                    }
                    
                    console.log('‚úÖ Barbearia criada com sucesso!');
                    if (alert) {
                        showAlert(alert, '‚úÖ Barbearia criada com sucesso!', 'success');
                    } else {
                        alert('Barbearia criada com sucesso!');
                    }
                }
                
                loadBarberDashboard();
            } catch (error) {
                console.error('‚ùå Erro ao salvar barbearia:', error);
                console.error('Detalhes:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                let errorMessage = error.message || 'Erro desconhecido ao salvar';
                
                // Mensagens mais amig√°veis
                if (error.message && error.message.includes('permission') || error.message.includes('RLS')) {
                    errorMessage = 'Erro de permiss√£o. Verifique se voc√™ est√° logado corretamente.';
                } else if (error.message && error.message.includes('foreign key')) {
                    errorMessage = 'Erro ao salvar. Verifique se todos os campos obrigat√≥rios est√£o preenchidos.';
                } else if (error.message && error.message.includes('duplicate')) {
                    errorMessage = 'J√° existe uma barbearia com estes dados.';
                }
                
                if (alert) {
                    showAlert(alert, '‚ùå ' + errorMessage, 'error');
                } else {
                    alert('Erro: ' + errorMessage);
                }
            }
        }
        
        function showAlert(element, message, type) {
            if (!element) {
                console.error('‚ùå Elemento de alerta n√£o encontrado!');
                alert(message); // Fallback para alert nativo
                return;
            }
            
            console.log('üì¢ Mostrando alerta:', { message, type, element: !!element });
            
            element.textContent = message;
            element.className = `alert alert-${type} show`;
            element.style.display = 'block';
            element.style.visibility = 'visible';
            element.style.opacity = '1';
            
            // Scroll para o alerta se necess√°rio
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-ocultar ap√≥s 5 segundos (apenas para sucesso)
            if (type === 'success') {
                setTimeout(() => {
                    if (element) {
                        element.classList.remove('show');
                        setTimeout(() => {
                            if (element) {
                                element.style.display = 'none';
                            }
                        }, 300);
                    }
                }, 5000);
            }
        }
        
        async function uploadImage(file, path) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random()}.${fileExt}`;
            const filePath = `${path}/${fileName}`;
            
            // Verificar se j√° existe arquivo no mesmo path e deletar
            const { data: existingFiles } = await supabase.storage
                .from('barbershops')
                .list(path, { limit: 100 });
            
            if (existingFiles && existingFiles.length > 0) {
                // Deletar arquivos antigos do mesmo tipo
                const filesToDelete = existingFiles.map(f => `${path}/${f.name}`);
                await supabase.storage
                    .from('barbershops')
                    .remove(filesToDelete);
            }
            
            // Fazer upload do novo arquivo
            const { error: uploadError } = await supabase.storage
                .from('barbershops')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (uploadError) {
                console.error('Erro no upload:', uploadError);
                throw new Error('Erro ao fazer upload da imagem: ' + uploadError.message);
            }
            
            // Obter URL p√∫blica
            const { data } = supabase.storage
                .from('barbershops')
                .getPublicUrl(filePath);
            
            return data.publicUrl;
        }
        
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        async function logout() {
            console.log('üîí Fazendo logout...');
            
            try {
                // Fazer logout no Supabase (n√£o esperar se der erro)
                supabase.auth.signOut().catch(err => {
                    console.warn('‚ö†Ô∏è Erro no signOut (continuando mesmo assim):', err);
                });
            } catch (err) {
                console.warn('‚ö†Ô∏è Erro ao chamar signOut (continuando mesmo assim):', err);
            }
            
            // Limpar dados locais IMEDIATAMENTE
            currentUser = null;
            window.currentUser = null;
            
            // Limpar localStorage
            try {
                localStorage.removeItem('supabase.auth.token');
                localStorage.removeItem('sb-' + SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token');
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao limpar localStorage:', e);
            }
            
            // Mostrar tela de login IMEDIATAMENTE
            showLoginScreen();
            
            console.log('‚úÖ Logout conclu√≠do');
        }
        
        // Verificar autentica√ß√£o ao carregar
        checkAuth().then(async () => {
            // Garantir que currentUser est√° atualizado
            if (!currentUser || !currentUser.id) {
                try {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (user && user.id) {
                        currentUser = user;
                        console.log('‚úÖ currentUser atualizado na inicializa√ß√£o:', currentUser.id);
                    }
                } catch (error) {
                    console.error('Erro ao atualizar currentUser:', error);
                }
            }
            
            if (currentUser && currentUser.id) {
                loadBarberDashboard();
            }
        });
    </script>
</body>
</html>

